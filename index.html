<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üõí Compras Paulina</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3737/3737372.png">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #CF1015;
            --primary-dark: #a00d11;
            --success: #22c55e;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --border: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 70px;
        }

        /* ==================== HEADER ==================== */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 14px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.1rem;
        }

        .header .subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        /* ==================== WEEK SELECTOR ==================== */
        .week-selector {
            background: linear-gradient(135deg, #2d3748, #1a202c);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .week-dropdown {
            flex: 1;
            padding: 10px 14px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            background: white;
            color: var(--text);
            cursor: pointer;
        }

        .week-btn {
            padding: 10px 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .week-btn:active {
            background: rgba(255,255,255,0.3);
        }

        .week-btn.danger {
            background: rgba(239, 68, 68, 0.7);
        }

        .sync-status {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sync-status.synced {
            color: #4ade80;
        }

        .sync-status.syncing {
            color: #fbbf24;
        }

        .sync-status.error {
            color: #f87171;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sync-status.syncing::before {
            content: '';
            width: 10px;
            height: 10px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 340px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal h3 {
            margin-bottom: 16px;
            font-size: 1.1rem;
        }

        .modal input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .modal input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-btns {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: var(--primary);
            color: white;
        }

        .modal-btn.secondary {
            background: #f0f0f0;
            color: var(--text);
        }

        /* ==================== QUICK REGISTER ==================== */
        .quick-register {
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            padding: 16px;
            color: white;
            position: sticky;
            top: 52px;
            z-index: 99;
        }

        .register-row {
            display: flex;
            gap: 8px;
        }

        .register-input {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            color: var(--text);
        }

        .register-input::placeholder {
            color: #999;
        }

        .register-input:focus {
            outline: 2px solid var(--success);
        }

        .btn-register {
            padding: 14px 20px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-voice {
            padding: 14px 16px;
            background: var(--info);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .btn-voice.recording {
            background: #dc3545;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .register-hint {
            font-size: 0.75rem;
            opacity: 0.85;
            margin-top: 10px;
        }

        .register-hint code {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Match Preview */
        .match-preview {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
            border-radius: 8px;
            padding: 10px 12px;
            margin-top: 12px;
            display: none;
        }

        .match-preview.active {
            display: block;
        }

        .match-preview.no-match {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
        }

        .match-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 0.9rem;
        }

        .match-item .product {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .match-item .status {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.3);
        }

        .match-item .price {
            font-weight: bold;
            color: #4ade80;
        }

        /* ==================== TOTALS BAR ==================== */
        .totals-bar {
            display: flex;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .total-box {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-right: 1px solid var(--border);
        }

        .total-box:last-child {
            border-right: none;
        }

        .total-box .value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--success);
        }

        .total-box .value.pending {
            color: var(--warning);
        }

        .total-box .label {
            font-size: 0.7rem;
            color: var(--text-light);
            text-transform: uppercase;
        }

        /* ==================== PERSON TOTALS ==================== */
        .person-totals {
            display: flex;
            gap: 8px;
            padding: 8px 16px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .person-totals:empty {
            display: none;
        }

        .person-total {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .person-total .name {
            font-weight: 500;
            color: var(--text-light);
        }

        .person-total .amount {
            font-weight: bold;
            color: var(--success);
        }

        /* ==================== SEARCH BAR ==================== */
        .search-bar {
            display: flex;
            padding: 8px 16px;
            gap: 8px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .search-bar input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--bg);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .clear-search {
            padding: 0 14px;
            border: none;
            background: var(--border);
            border-radius: 8px;
            font-size: 1.2rem;
            color: var(--text-light);
            cursor: pointer;
            display: none;
        }

        .clear-search.visible {
            display: block;
        }

        /* ==================== LIST TABS ==================== */
        .list-tabs {
            display: flex;
            padding: 8px 16px;
            gap: 8px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .list-tab {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            background: #f0f0f0;
            color: var(--text);
        }

        .list-tab.active {
            background: var(--primary);
            color: white;
        }

        /* ==================== SHOPPING LIST ==================== */
        .list-container {
            padding: 12px;
        }

        .category {
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 10px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        .category-header {
            padding: 12px 14px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            cursor: pointer;
        }

        .category-header .count {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--text-light);
            font-weight: normal;
        }

        .category-header .cat-total {
            font-size: 0.8rem;
            color: var(--success);
            font-weight: bold;
        }

        .category.collapsed .category-content {
            display: none;
        }

        .category-header .toggle {
            font-size: 0.7rem;
            transition: transform 0.2s;
        }

        .category.collapsed .toggle {
            transform: rotate(-90deg);
        }

        /* Items */
        .item {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item.bought {
            background: linear-gradient(90deg, #f0fdf4, #dcfce7);
        }

        .item.bought .item-name {
            text-decoration: line-through;
            color: var(--text-light);
        }

        .item.highlight {
            animation: highlightPulse 1s ease;
        }

        @keyframes highlightPulse {
            0% { background: #fef08a; }
            100% { background: #f0fdf4; }
        }

        .item-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .item.bought .item-check {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-size: 0.9rem;
            line-height: 1.3;
        }

        .item-price {
            font-size: 0.95rem;
            font-weight: bold;
            color: var(--success);
            margin-left: 10px;
            white-space: nowrap;
        }

        /* Extra indicator */
        .item.extra {
            background: #fffbeb;
            border-left: 3px solid var(--warning);
        }

        .item.extra .item-check {
            border-color: var(--warning);
        }

        .item.extra.bought .item-check {
            background: var(--warning);
            border-color: var(--warning);
        }

        .extra-badge {
            font-size: 0.65rem;
            background: var(--warning);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        .bought-by {
            font-size: 0.65rem;
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            opacity: 0.8;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 1.1rem;
            padding: 4px 8px;
            cursor: pointer;
            opacity: 0.5;
        }

        .delete-btn:active {
            opacity: 1;
        }

        /* ==================== BOTTOM ACTIONS ==================== */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            padding: 10px 16px;
            display: flex;
            gap: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .bottom-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .bottom-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .bottom-btn.secondary {
            background: #f0f0f0;
            color: var(--text);
        }

        /* ==================== TOAST ==================== */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 90%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: #ef4444; }
        .toast.warning { background: var(--warning); }

        /* ==================== EMPTY STATE ==================== */
        .empty-message {
            text-align: center;
            padding: 30px;
            color: var(--text-light);
        }

        /* ==================== LOGIN SCREEN ==================== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 20px;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            max-width: 340px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-card h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .login-card h2 {
            font-size: 1.2rem;
            color: var(--text);
            margin-bottom: 8px;
        }

        .login-card p {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 30px;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 14px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: white;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .google-btn:hover {
            background: #f8f8f8;
            border-color: #ccc;
        }

        .google-btn:active {
            transform: scale(0.98);
        }

        .google-btn img {
            width: 20px;
            height: 20px;
        }

        .login-error {
            margin-top: 16px;
            padding: 12px;
            background: #fef2f2;
            border-radius: 8px;
            color: #dc2626;
            font-size: 0.85rem;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* User Info Bar */
        .user-bar {
            background: linear-gradient(135deg, #1f2937, #111827);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 0.8rem;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .user-name {
            flex: 1;
            opacity: 0.9;
        }

        .logout-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .logout-btn:active {
            background: rgba(255,255,255,0.2);
        }

        /* Import button */
        .import-btn {
            background: #8b5cf6;
            color: white;
        }

        .app-content {
            display: none;
        }

        .app-content.visible {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <h1>üõí</h1>
            <h2>Compras Semanales</h2>
            <p>Inici√° sesi√≥n para sincronizar tus listas de compras</p>
            <button class="google-btn" onclick="signInWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                Continuar con Google
            </button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <!-- App Content (hidden until login) -->
    <div class="app-content" id="appContent">
        <!-- User Bar -->
        <div class="user-bar" id="userBar">
            <div class="user-avatar" id="userAvatar">?</div>
            <span class="user-name" id="userName">Usuario</span>
            <button class="logout-btn" onclick="signOutUser()">Salir</button>
        </div>

        <div class="header">
            <h1 id="headerTitle">üõí Compras Semanales</h1>
            <div class="subtitle" id="headerSubtitle">Seleccion√° una semana</div>
        </div>

    <!-- Week Selector -->
    <div class="week-selector">
        <select id="weekDropdown" class="week-dropdown" onchange="selectWeek(this.value)">
            <option value="">Cargando semanas...</option>
        </select>
        <button class="week-btn" onclick="openNewWeekModal()" title="Nueva semana">‚ûï</button>
        <button class="week-btn danger" onclick="deleteCurrentWeek()" title="Eliminar semana">üóëÔ∏è</button>
        <div class="sync-status" id="syncStatus">
            <span>‚òÅÔ∏è</span> <span id="syncText">Local</span>
        </div>
    </div>

    <!-- Modal Nueva Semana -->
    <div class="modal-overlay" id="newWeekModal">
        <div class="modal">
            <h3>üìÖ Nueva Semana</h3>
            <input type="text" id="weekNameInput" placeholder="Ej: Semana 5 - Febrero" maxlength="40">
            <div class="modal-btns">
                <button class="modal-btn secondary" onclick="closeNewWeekModal()">Cancelar</button>
                <button class="modal-btn primary" onclick="createNewWeek()">Crear</button>
            </div>
        </div>
    </div>

    <!-- Quick Register -->
    <div class="quick-register">
        <div class="register-row">
            <input type="text" 
                   id="registerInput" 
                   class="register-input" 
                   placeholder="leche 2500, pan 1200..."
                   autocomplete="off">
            <button class="btn-register" onclick="processInput()">‚úì</button>
            <button class="btn-voice" id="voiceBtn" onclick="toggleVoice()">üé§</button>
        </div>
        <div class="register-hint">
            üí° Escrib√≠ el producto y precio: <code>leche 2500</code> ‚Äî Se tacha de la lista y suma al total
        </div>
        <div class="match-preview" id="matchPreview"></div>
    </div>

    <!-- Totals -->
    <div class="totals-bar">
        <div class="total-box">
            <div class="value" id="totalSpent">$0</div>
            <div class="label">Gastado</div>
        </div>
        <div class="total-box">
            <div class="value pending" id="pendingCount">0</div>
            <div class="label">Pendientes</div>
        </div>
        <div class="total-box">
            <div class="value" id="boughtCount">0</div>
            <div class="label">Comprados</div>
        </div>
    </div>

    <!-- Gastos por persona -->
    <div class="person-totals" id="personTotals"></div>

    <!-- Search Bar -->
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="üîç Buscar item..." oninput="filterList()">
        <button class="clear-search" onclick="clearSearch()" id="clearSearchBtn">√ó</button>
    </div>

    <!-- List Type Tabs -->
    <div class="list-tabs">
        <button class="list-tab active" onclick="switchList('general')">üçñ General</button>
        <button class="list-tab" onclick="switchList('veggie')">ü•¨ Vegetariana</button>
    </div>

    <!-- Shopping List -->
    <div class="list-container" id="listContainer"></div>

        <!-- Bottom Actions -->
        <div class="bottom-bar">
            <button class="bottom-btn secondary" onclick="resetAll()">üóëÔ∏è</button>
            <button class="bottom-btn secondary" onclick="addExtra()">‚ûï Extra</button>
            <button class="bottom-btn import-btn" onclick="openImportModal()">üì• Paulina</button>
            <button class="bottom-btn whatsapp" onclick="shareWhatsApp()">üì±</button>
        </div>
    </div><!-- End app-content -->

    <!-- Modal Importar desde Paulina -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <h3>üì• Importar de Paulina Cocina</h3>
            <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 12px;">
                Peg√° el JSON generado por el scraper o ingres√° el n√∫mero de semana
            </p>
            <input type="number" id="weekNumberInput" placeholder="N√∫mero de semana (ej: 5)" min="1" max="52" style="margin-bottom: 8px;">
            <textarea id="importJsonInput" placeholder="O peg√° el JSON aqu√≠..." style="width: 100%; height: 100px; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 0.9rem; resize: none; margin-bottom: 12px;"></textarea>
            <div class="modal-btns">
                <button class="modal-btn secondary" onclick="closeImportModal()">Cancelar</button>
                <button class="modal-btn primary" onclick="importFromPaulina()">Importar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAv_ko7n9m9dG-NUuKkz8jLS1vQOE3NOgs",
          authDomain: "compras-semanales-72dd1.firebaseapp.com",
          projectId: "compras-semanales-72dd1",
          storageBucket: "compras-semanales-72dd1.firebasestorage.app",
          messagingSenderId: "1079679650059",
          appId: "1:1079679650059:web:dd70afc49639b2cde27a0e",
          measurementId: "G-YPZ2K4SX5E"
        };

        // Usuarios autorizados
        const ALLOWED_EMAILS = [
            'matiarona@gmail.com',
            'vickyswag02@gmail.com'
        ];

        // Initialize Firebase
        let db = null;
        let auth = null;
        let currentUser = null;
        let firebaseReady = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            firebaseReady = true;
            console.log('Firebase inicializado');
        } catch (error) {
            console.warn('Firebase no disponible, usando solo localStorage:', error);
        }

        // ==================== AUTHENTICATION ====================
        function isEmailAllowed(email) {
            return ALLOWED_EMAILS.includes(email.toLowerCase());
        }

        async function signInWithGoogle() {
            if (!auth) {
                showLoginError('Firebase no est√° configurado. Revis√° SETUP_FIREBASE.md');
                return;
            }

            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });

                const result = await auth.signInWithPopup(provider);
                const user = result.user;

                // Verificar si el email est√° autorizado
                if (!isEmailAllowed(user.email)) {
                    await auth.signOut();
                    showLoginError(`El email ${user.email} no est√° autorizado. Solo Mati y Vicky pueden usar esta app.`);
                    return;
                }

                // Login exitoso, el observer manejar√° el resto
            } catch (error) {
                console.error('Error en login:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    return; // Usuario cerr√≥ el popup, no mostrar error
                }
                showLoginError('Error al iniciar sesi√≥n: ' + error.message);
            }
        }

        async function signOutUser() {
            if (!auth) return;

            try {
                await auth.signOut();
                showLoginScreen();
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContent').classList.remove('visible');
        }

        function showAppContent() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContent').classList.add('visible');
        }

        function showLoginError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function updateUserUI(user) {
            if (!user) return;

            const avatar = document.getElementById('userAvatar');
            const name = document.getElementById('userName');

            if (user.photoURL) {
                avatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar">`;
            } else {
                avatar.textContent = user.email.charAt(0).toUpperCase();
            }

            // Mostrar nombre corto
            const firstName = user.displayName ? user.displayName.split(' ')[0] : user.email.split('@')[0];
            name.textContent = firstName;
        }

        // Auth state observer
        if (auth) {
            auth.onAuthStateChanged(async (user) => {
                if (user && isEmailAllowed(user.email)) {
                    currentUser = user;
                    updateUserUI(user);
                    showAppContent();
                    await loadAllData();
                } else {
                    currentUser = null;
                    showLoginScreen();
                }
            });
        }

        // ==================== DATA ====================
        let currentList = 'general';
        let currentWeekId = null;
        let weeks = {}; // weekId -> { name, createdAt, items, itemIdCounter, currentList }
        let items = {}; // id -> { name, category, bought, price, isExtra }
        let searchFilter = ''; // Filtro de b√∫squeda actual
        let itemIdCounter = 0;

        const shoppingData = {
            general: {
                "Supermercado üè™": [
                    "1 manteca chica (3 cdas. aprox.)",
                    "4 huevos",
                    "1 lata de at√∫n",
                    "1 lata de choclo",
                    "250g de queso parmesano rallado",
                    "1 pote chico de queso crema",
                    "1 paquete de pan rallado",
                    "1 vino blanco",
                    "1 flauta de pan",
                    "1 paquete de fideos (300g)",
                    "1 masa para tarta",
                    "1 pote chico de crema de leche",
                    "Leche",
                    "1 paquete de pan de hamburguesas"
                ],
                "Carnes ü•©": [
                    "500g de carne de cerdo",
                    "100g de panceta"
                ],
                "Diet√©tica ü•ó": [
                    "100g de nueces"
                ],
                "Verduler√≠a ü•¨": [
                    "1 calabaza chica",
                    "2 berenjenas",
                    "4 cebollas de verdeo",
                    "1 atado de espinaca",
                    "4 papas",
                    "400g de tomates maduros",
                    "3 dientes de ajo",
                    "3 zanahorias",
                    "1 morr√≥n rojo",
                    "1 cebolla morada",
                    "1 atado de albahaca",
                    "2 puerros",
                    "1 cebolla",
                    "¬Ω repollo morado",
                    "1 atado de cilantro",
                    "Jengibre",
                    "1 chile o aj√≠ picante"
                ],
                "Yapa ‚≠ê": [
                    "550g de harina integral",
                    "1 paquetito de levadura seca",
                    "1 paquete de aceitunas",
                    "Romero"
                ],
                "Comod√≠n üëë": [
                    "4 huevos extra",
                    "1 pan lactal",
                    "Mayonesa",
                    "100g de lomito en fetas",
                    "250g de tomates cherry"
                ]
            },
            veggie: {
                "Supermercado üè™": [
                    "1 manteca chica",
                    "4 huevos",
                    "400g de queso parmesano rallado",
                    "1 pote chico de queso crema",
                    "250g de lentejas",
                    "1 paquete de pan rallado",
                    "1 vino blanco",
                    "1 flauta de pan",
                    "Leche",
                    "1 paquete de fideos (300g)",
                    "1 pote chico de crema de leche",
                    "1 masa para tarta",
                    "1 paquete de pan de hamburguesas"
                ],
                "Diet√©tica ü•ó": [
                    "250g de girgolas o shitake",
                    "150g de nueces",
                    "100g de tomates secos"
                ],
                "Verduler√≠a ü•¨": [
                    "2 berenjenas",
                    "1 calabaza chica",
                    "4 zanahorias",
                    "2 cebollas",
                    "4 dientes de ajo",
                    "1 morr√≥n rojo",
                    "4 cebollas de verdeo",
                    "4 papas",
                    "400g de tomates maduros",
                    "1 cebolla morada",
                    "1 atado de albahaca",
                    "2 puerros",
                    "¬Ω repollo morado",
                    "Jengibre",
                    "1 atado de cilantro",
                    "1 chile o aj√≠ picante",
                    "250g de champi√±ones"
                ],
                "Yapa ‚≠ê": [
                    "550g de harina integral",
                    "1 paquetito de levadura seca",
                    "1 paquete de aceitunas",
                    "Romero"
                ],
                "Comod√≠n üëë": [
                    "4 huevos extra",
                    "1 pan lactal",
                    "Mayonesa",
                    "250g de tomates cherry"
                ]
            }
        };

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Setup input listeners
            document.getElementById('registerInput').addEventListener('input', showPreview);
            document.getElementById('registerInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') processInput();
            });

            // Enter en el input de nueva semana
            document.getElementById('weekNameInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') createNewWeek();
            });

            // Si no hay Firebase Auth configurado, mostrar la app directamente (modo local)
            if (!auth) {
                showAppContent();
                await loadAllData();
            }
            // Si hay auth, el observer se encargar√° de cargar los datos
        });

        async function loadAllData() {
            updateSyncStatus('syncing', 'Cargando...');

            // Primero cargar de localStorage
            loadFromLocalStorage();

            // Si Firebase est√° disponible, sincronizar
            if (firebaseReady) {
                try {
                    await syncFromFirestore();
                    updateSyncStatus('synced', 'Sincronizado');
                } catch (error) {
                    console.error('Error syncing from Firestore:', error);
                    updateSyncStatus('error', 'Sin conexi√≥n');
                }
            } else {
                updateSyncStatus('error', 'Solo local');
            }

            // Renderizar semanas disponibles
            renderWeeksDropdown();

            // Si no hay semanas, crear una por defecto
            if (Object.keys(weeks).length === 0) {
                const defaultWeekId = createWeekData('Semana 1');
                currentWeekId = defaultWeekId;
                await saveWeekToCloud(defaultWeekId);
            }

            // Seleccionar semana actual
            if (currentWeekId && weeks[currentWeekId]) {
                selectWeek(currentWeekId);
            } else {
                // Seleccionar la m√°s reciente
                const weekIds = Object.keys(weeks).sort((a, b) =>
                    (weeks[b].createdAt || 0) - (weeks[a].createdAt || 0)
                );
                if (weekIds.length > 0) {
                    selectWeek(weekIds[0]);
                }
            }
        }

        function initializeItems() {
            // Reinicializar items de la lista actual (dentro de la semana)
            const data = shoppingData[currentList];

            // Remover items actuales de este listType
            for (const [id, item] of Object.entries(items)) {
                if (item.listType === currentList) {
                    delete items[id];
                }
            }

            // Crear nuevos items
            for (const [category, productList] of Object.entries(data)) {
                for (const product of productList) {
                    items[itemIdCounter++] = {
                        name: product,
                        category: category,
                        bought: false,
                        price: 0,
                        isExtra: false,
                        listType: currentList
                    };
                }
            }
        }

        // ==================== MATCHING ====================
        function normalizeText(text) {
            return text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove accents
                .replace(/[^a-z0-9\s]/g, ' ')
                .trim();
        }

        function findMatches(searchText) {
            const normalized = normalizeText(searchText);
            const words = normalized.split(/\s+/).filter(w => w.length > 2);
            
            if (words.length === 0) return [];

            const matches = [];
            
            for (const [id, item] of Object.entries(items)) {
                if (item.listType !== currentList) continue;
                
                const itemNormalized = normalizeText(item.name);
                
                // Check if any search word matches
                let score = 0;
                for (const word of words) {
                    if (itemNormalized.includes(word)) {
                        score += word.length;
                        // Bonus for word at start
                        if (itemNormalized.startsWith(word)) score += 5;
                    }
                }
                
                if (score > 0) {
                    matches.push({ id: parseInt(id), item, score });
                }
            }
            
            // Sort by score descending
            matches.sort((a, b) => b.score - a.score);
            
            return matches.slice(0, 3); // Top 3 matches
        }

        // ==================== INPUT PROCESSING ====================
        function parseInput(text) {
            const results = [];
            const parts = text.split(/[,;]/);
            
            for (let part of parts) {
                part = part.trim();
                if (!part) continue;

                // Match: "producto 1234" or "producto $1.234"
                const match = part.match(/^(.+?)\s+\$?(\d{1,3}(?:[.,]\d{3})*|\d+)\s*$/);
                
                if (match) {
                    const searchText = match[1].trim();
                    let price = match[2].replace(/\./g, '').replace(',', '.');
                    price = parseInt(price) || 0;
                    
                    const matches = findMatches(searchText);
                    
                    results.push({
                        searchText,
                        price,
                        matches,
                        bestMatch: matches.length > 0 ? matches[0] : null
                    });
                }
            }
            
            return results;
        }

        function showPreview(e) {
            const text = e.target.value;
            const preview = document.getElementById('matchPreview');
            
            if (!text.trim()) {
                preview.classList.remove('active');
                return;
            }

            const parsed = parseInput(text);
            
            if (parsed.length === 0) {
                preview.classList.remove('active');
                return;
            }

            let html = '';
            let hasNoMatch = false;

            for (const item of parsed) {
                if (item.bestMatch) {
                    const alreadyBought = item.bestMatch.item.bought;
                    html += `
                        <div class="match-item">
                            <div class="product">
                                <span>${alreadyBought ? '‚úì' : '‚Üí'}</span>
                                <span>${item.bestMatch.item.name}</span>
                            </div>
                            <span class="price">$${item.price.toLocaleString('es-AR')}</span>
                        </div>
                    `;
                } else {
                    hasNoMatch = true;
                    html += `
                        <div class="match-item">
                            <div class="product">
                                <span>‚ûï</span>
                                <span>"${item.searchText}" (se agregar√° como extra)</span>
                            </div>
                            <span class="price">$${item.price.toLocaleString('es-AR')}</span>
                        </div>
                    `;
                }
            }

            preview.innerHTML = html;
            preview.classList.add('active');
            preview.classList.toggle('no-match', hasNoMatch);
        }

        function processInput() {
            const input = document.getElementById('registerInput');
            const text = input.value.trim();
            
            if (!text) return;

            const parsed = parseInput(text);
            
            if (parsed.length === 0) {
                showToast('Agreg√° el precio. Ej: leche 2500', 'warning');
                return;
            }

            let totalAdded = 0;
            let itemsProcessed = [];

            for (const item of parsed) {
                if (item.bestMatch) {
                    // Mark as bought and set price
                    const id = item.bestMatch.id;
                    items[id].bought = true;
                    items[id].price = item.price;
                    items[id].boughtBy = currentUser?.displayName || currentUser?.email || 'An√≥nimo';
                    totalAdded += item.price;
                    itemsProcessed.push(items[id].name);
                    
                    // Highlight animation
                    setTimeout(() => {
                        const el = document.querySelector(`[data-id="${id}"]`);
                        if (el) {
                            el.classList.add('highlight');
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                } else {
                    // Add as extra
                    const newId = itemIdCounter++;
                    items[newId] = {
                        name: item.searchText.charAt(0).toUpperCase() + item.searchText.slice(1),
                        category: 'Extras ‚ûï',
                        bought: true,
                        price: item.price,
                        isExtra: true,
                        listType: currentList,
                        boughtBy: currentUser?.displayName || currentUser?.email || 'An√≥nimo'
                    };
                    totalAdded += item.price;
                    itemsProcessed.push(items[newId].name + ' (extra)');
                }
            }

            input.value = '';
            document.getElementById('matchPreview').classList.remove('active');
            
            renderList();
            updateTotals();
            saveData();
            
            showToast(`‚úì +$${totalAdded.toLocaleString('es-AR')}`, 'success');
        }

        // ==================== RENDER ====================
        function renderList() {
            const container = document.getElementById('listContainer');
            
            // Group items by category
            const categories = {};
            
            for (const [id, item] of Object.entries(items)) {
                if (item.listType !== currentList) continue;

                // Aplicar filtro de b√∫squeda
                if (searchFilter && !item.name.toLowerCase().includes(searchFilter)) {
                    continue;
                }

                const cat = item.category;
                if (!categories[cat]) {
                    categories[cat] = [];
                }
                categories[cat].push({ id: parseInt(id), ...item });
            }

            // Sort: unbought first, then by name
            for (const cat of Object.keys(categories)) {
                categories[cat].sort((a, b) => {
                    if (a.bought !== b.bought) return a.bought ? 1 : -1;
                    return a.name.localeCompare(b.name);
                });
            }

            // Define category order
            const categoryOrder = [
                'Supermercado üè™',
                'Carnes ü•©',
                'Diet√©tica ü•ó',
                'Verduler√≠a ü•¨',
                'Yapa ‚≠ê',
                'Comod√≠n üëë',
                'Extras ‚ûï'
            ];

            let html = '';

            for (const catName of categoryOrder) {
                const catItems = categories[catName];
                if (!catItems || catItems.length === 0) continue;

                const boughtCount = catItems.filter(i => i.bought).length;
                const catTotal = catItems.reduce((sum, i) => sum + (i.price || 0), 0);

                html += `
                    <div class="category" data-category="${catName}">
                        <div class="category-header" onclick="toggleCategory(this)">
                            <span>${catName}</span>
                            <span class="count">${boughtCount}/${catItems.length}</span>
                            ${catTotal > 0 ? `<span class="cat-total">$${catTotal.toLocaleString('es-AR')}</span>` : ''}
                            <span class="toggle">‚ñº</span>
                        </div>
                        <div class="category-content">
                            ${catItems.map(item => `
                                <div class="item ${item.bought ? 'bought' : ''} ${item.isExtra ? 'extra' : ''}"
                                     data-id="${item.id}" onclick="toggleItem(${item.id})">
                                    <div class="item-check">${item.bought ? '‚úì' : ''}</div>
                                    <div class="item-info">
                                        <span class="item-name">${item.name}</span>
                                        ${item.isExtra ? '<span class="extra-badge">EXTRA</span>' : ''}
                                        ${item.boughtBy ? `<span class="bought-by">${item.boughtBy.split(' ')[0]}</span>` : ''}
                                    </div>
                                    ${item.bought ? `<span class="item-price" onclick="editPrice(${item.id}, event)">$${(item.price || 0).toLocaleString('es-AR')}</span>` : ''}
                                    ${item.isExtra ? `<button class="delete-btn" onclick="deleteItem(${item.id}, event)">√ó</button>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html || '<div class="empty-message">No hay items</div>';
        }

        function toggleCategory(header) {
            header.parentElement.classList.toggle('collapsed');
        }

        function filterList() {
            const input = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            searchFilter = input.value.toLowerCase().trim();

            // Mostrar/ocultar bot√≥n de limpiar
            if (searchFilter) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }

            renderList();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchFilter = '';
            document.getElementById('clearSearchBtn').classList.remove('visible');
            renderList();
        }

        function updateTotals() {
            let totalSpent = 0;
            let pending = 0;
            let bought = 0;
            const byPerson = {}; // { nombre: total }

            for (const [id, item] of Object.entries(items)) {
                if (item.listType !== currentList) continue;

                if (item.bought) {
                    bought++;
                    totalSpent += item.price || 0;

                    // Sumar por persona
                    if (item.boughtBy && item.price > 0) {
                        const name = item.boughtBy.split(' ')[0]; // Solo el primer nombre
                        byPerson[name] = (byPerson[name] || 0) + item.price;
                    }
                } else {
                    pending++;
                }
            }

            document.getElementById('totalSpent').textContent = `$${totalSpent.toLocaleString('es-AR')}`;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('boughtCount').textContent = bought;

            // Mostrar totales por persona
            const personTotalsDiv = document.getElementById('personTotals');
            const personNames = Object.keys(byPerson);

            if (personNames.length > 0) {
                personTotalsDiv.innerHTML = personNames.map(name => `
                    <div class="person-total">
                        <span class="name">${name}:</span>
                        <span class="amount">$${byPerson[name].toLocaleString('es-AR')}</span>
                    </div>
                `).join('');
            } else {
                personTotalsDiv.innerHTML = '';
            }
        }

        // ==================== ACTIONS ====================
        function switchList(type) {
            currentList = type;
            document.querySelectorAll('.list-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Check if we have items for this list type
            const hasItems = Object.values(items).some(i => i.listType === type);
            if (!hasItems) {
                initializeItems();
            }

            renderList();
            updateTotals();
            saveData(); // Guardar cambio de lista
        }

        function addExtra() {
            const name = prompt('Nombre del producto extra:');
            if (!name) return;
            
            const priceStr = prompt('Precio (o dej√° vac√≠o):');
            const price = parseInt(priceStr) || 0;
            
            const newId = itemIdCounter++;
            items[newId] = {
                name: name.charAt(0).toUpperCase() + name.slice(1),
                category: 'Extras ‚ûï',
                bought: price > 0,
                price: price,
                isExtra: true,
                listType: currentList,
                boughtBy: price > 0 ? (currentUser?.displayName || currentUser?.email || 'An√≥nimo') : null
            };
            
            renderList();
            updateTotals();
            saveData();
            showToast('Extra agregado', 'success');
        }

        function toggleItem(id) {
            const strId = String(id);
            if (!items[strId]) return;

            const item = items[strId];
            if (item.bought) {
                // Desmarcar
                item.bought = false;
                item.price = 0;
                item.boughtBy = null;
                showToast('Item desmarcado', 'info');
            } else {
                // Marcar como comprado - pedir precio
                const priceStr = prompt(`Precio de "${item.name}":`);
                if (priceStr === null) return; // Cancel√≥
                const price = parseInt(priceStr) || 0;
                item.bought = true;
                item.price = price;
                item.boughtBy = currentUser?.displayName || currentUser?.email || 'An√≥nimo';
                showToast('Item marcado', 'success');
            }

            renderList();
            updateTotals();
            saveData();
        }

        function editPrice(id, event) {
            event.stopPropagation();
            const strId = String(id);
            if (!items[strId]) return;

            const item = items[strId];
            const newPrice = prompt(`Nuevo precio de "${item.name}":`, item.price || 0);
            if (newPrice === null) return; // Cancel√≥

            item.price = parseInt(newPrice) || 0;
            renderList();
            updateTotals();
            saveData();
            showToast('Precio actualizado', 'success');
        }

        function deleteItem(id, event) {
            if (event) event.stopPropagation();
            // Convertir a string porque las keys de objetos JSON son siempre strings
            const strId = String(id);
            if (items[strId] && items[strId].isExtra) {
                delete items[strId];
                renderList();
                updateTotals();
                saveData();
                showToast('Item eliminado', 'success');
            }
        }

        function resetAll() {
            if (!confirm('¬øReiniciar todo? Se borrar√°n los precios y compras.')) return;
            
            initializeItems();
            renderList();
            updateTotals();
            saveData();
            showToast('Lista reiniciada', 'success');
        }

        function shareWhatsApp() {
            const listItems = Object.values(items).filter(i => i.listType === currentList);
            const bought = listItems.filter(i => i.bought);
            const pending = listItems.filter(i => !i.bought);
            const total = bought.reduce((sum, i) => sum + (i.price || 0), 0);

            let text = `üõí *Compras - ${new Date().toLocaleDateString('es-AR')}*\n\n`;
            
            if (bought.length > 0) {
                text += `‚úÖ *Comprado (${bought.length}):*\n`;
                bought.forEach(i => {
                    text += `‚Ä¢ ${i.name}`;
                    if (i.price) text += ` - $${i.price.toLocaleString('es-AR')}`;
                    text += '\n';
                });
                text += `\nüí∞ *TOTAL: $${total.toLocaleString('es-AR')}*\n`;
            }

            if (pending.length > 0) {
                text += `\n‚è≥ *Pendiente (${pending.length}):*\n`;
                pending.slice(0, 10).forEach(i => {
                    text += `‚Ä¢ ${i.name}\n`;
                });
                if (pending.length > 10) {
                    text += `... y ${pending.length - 10} m√°s\n`;
                }
            }

            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        }

        // ==================== VOICE ====================
        let recognition = null;
        let isRecording = false;

        function toggleVoice() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                showToast('Voz no soportada', 'error');
                return;
            }

            const btn = document.getElementById('voiceBtn');

            if (isRecording) {
                recognition.stop();
                btn.classList.remove('recording');
                btn.textContent = 'üé§';
                isRecording = false;
            } else {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SR();
                recognition.lang = 'es-AR';
                recognition.continuous = false;

                recognition.onresult = function(e) {
                    document.getElementById('registerInput').value = e.results[0][0].transcript;
                    showPreview({ target: document.getElementById('registerInput') });
                    btn.classList.remove('recording');
                    btn.textContent = 'üé§';
                    isRecording = false;
                };

                recognition.onerror = function() {
                    btn.classList.remove('recording');
                    btn.textContent = 'üé§';
                    isRecording = false;
                };

                recognition.start();
                btn.classList.add('recording');
                btn.textContent = '‚èπ';
                isRecording = true;
                showToast('üé§ Habl√°...', 'success');
            }
        }

        // ==================== STORAGE ====================
        function saveData() {
            // Guardar estado actual de la semana
            if (currentWeekId) {
                weeks[currentWeekId] = {
                    ...weeks[currentWeekId],
                    items: items,
                    itemIdCounter: itemIdCounter,
                    currentList: currentList,
                    updatedAt: Date.now()
                };
            }

            // Guardar en localStorage
            saveToLocalStorage();

            // Guardar en la nube
            if (currentWeekId) {
                saveWeekToCloud(currentWeekId);
            }
        }

        function saveToLocalStorage() {
            const data = {
                weeks: weeks,
                currentWeekId: currentWeekId
            };
            localStorage.setItem('paulina_v5_weeks', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            // Intentar cargar nuevo formato
            const saved = localStorage.getItem('paulina_v5_weeks');
            if (saved) {
                const data = JSON.parse(saved);
                weeks = data.weeks || {};
                currentWeekId = data.currentWeekId || null;
                return;
            }

            // Migrar datos del formato anterior
            const oldSaved = localStorage.getItem('paulina_v4');
            if (oldSaved) {
                const oldData = JSON.parse(oldSaved);
                // Crear una semana con los datos anteriores
                const weekId = 'week_' + Date.now();
                weeks[weekId] = {
                    id: weekId,
                    name: 'Semana Migrada',
                    createdAt: Date.now(),
                    items: oldData.items || {},
                    itemIdCounter: oldData.itemIdCounter || 0,
                    currentList: oldData.currentList || 'general'
                };
                currentWeekId = weekId;
                saveToLocalStorage();
                // Opcional: eliminar datos viejos
                // localStorage.removeItem('paulina_v4');
            }
        }

        let unsubscribeListener = null;
        let lastSaveTime = 0;

        async function syncFromFirestore() {
            if (!firebaseReady || !db) return;

            const snapshot = await db.collection('weeks').get();

            snapshot.forEach(doc => {
                const weekData = doc.data();
                const localWeek = weeks[doc.id];

                // Si no existe localmente o el de la nube es m√°s reciente, usar el de la nube
                if (!localWeek || (weekData.updatedAt > (localWeek.updatedAt || 0))) {
                    weeks[doc.id] = {
                        id: doc.id,
                        ...weekData
                    };
                }
            });

            // Iniciar listener en tiempo real
            startRealtimeSync();
        }

        function startRealtimeSync() {
            if (!firebaseReady || !db || unsubscribeListener) return;

            unsubscribeListener = db.collection('weeks').onSnapshot(snapshot => {
                // Ignorar cambios propios (dentro de 2 segundos de guardar)
                if (Date.now() - lastSaveTime < 2000) return;

                let hasChanges = false;

                snapshot.docChanges().forEach(change => {
                    if (change.type === 'modified' || change.type === 'added') {
                        const weekData = change.doc.data();
                        const localWeek = weeks[change.doc.id];

                        // Solo actualizar si el de la nube es m√°s reciente
                        if (!localWeek || (weekData.updatedAt > (localWeek.updatedAt || 0))) {
                            weeks[change.doc.id] = {
                                id: change.doc.id,
                                ...weekData
                            };
                            hasChanges = true;
                        }
                    } else if (change.type === 'removed') {
                        if (weeks[change.doc.id]) {
                            delete weeks[change.doc.id];
                            hasChanges = true;
                        }
                    }
                });

                if (hasChanges) {
                    saveToLocalStorage();
                    renderWeeksDropdown();

                    // Si la semana actual fue modificada, recargar
                    if (currentWeekId && weeks[currentWeekId]) {
                        items = weeks[currentWeekId].items || {};
                        itemIdCounter = weeks[currentWeekId].itemIdCounter || 0;
                        renderList();
                        updateTotals();
                        showToast('Lista actualizada', 'info');
                    }

                    updateSyncStatus('synced', 'Sincronizado');
                }
            }, error => {
                console.error('Error en listener:', error);
                updateSyncStatus('error', 'Error de conexi√≥n');
            });
        }

        async function saveWeekToCloud(weekId) {
            if (!firebaseReady || !db || !weekId) return;

            const week = weeks[weekId];
            if (!week) return;

            updateSyncStatus('syncing', 'Guardando...');
            lastSaveTime = Date.now(); // Marcar que estamos guardando

            try {
                await db.collection('weeks').doc(weekId).set({
                    name: week.name,
                    createdAt: week.createdAt,
                    updatedAt: week.updatedAt || Date.now(),
                    items: week.items || {},
                    itemIdCounter: week.itemIdCounter || 0,
                    currentList: week.currentList || 'general'
                });
                updateSyncStatus('synced', 'Guardado');
            } catch (error) {
                console.error('Error saving to Firestore:', error);
                updateSyncStatus('error', 'Error al guardar');
            }
        }

        async function deleteWeekFromCloud(weekId) {
            if (!firebaseReady || !db || !weekId) return;

            try {
                await db.collection('weeks').doc(weekId).delete();
            } catch (error) {
                console.error('Error deleting from Firestore:', error);
            }
        }

        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('syncText');

            statusEl.className = 'sync-status ' + status;
            textEl.textContent = text;
        }

        // ==================== WEEKS MANAGEMENT ====================
        function createWeekData(name) {
            const weekId = 'week_' + Date.now();
            weeks[weekId] = {
                id: weekId,
                name: name,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                items: {},
                itemIdCounter: 0,
                currentList: 'general'
            };

            // Inicializar items por defecto
            const data = shoppingData['general'];
            let counter = 0;
            const newItems = {};

            for (const [category, productList] of Object.entries(data)) {
                for (const product of productList) {
                    newItems[counter++] = {
                        name: product,
                        category: category,
                        bought: false,
                        price: 0,
                        isExtra: false,
                        listType: 'general'
                    };
                }
            }

            // Tambi√©n inicializar veggie
            const veggieData = shoppingData['veggie'];
            for (const [category, productList] of Object.entries(veggieData)) {
                for (const product of productList) {
                    newItems[counter++] = {
                        name: product,
                        category: category,
                        bought: false,
                        price: 0,
                        isExtra: false,
                        listType: 'veggie'
                    };
                }
            }

            weeks[weekId].items = newItems;
            weeks[weekId].itemIdCounter = counter;

            return weekId;
        }

        function renderWeeksDropdown() {
            const dropdown = document.getElementById('weekDropdown');
            const weekIds = Object.keys(weeks).sort((a, b) =>
                (weeks[b].createdAt || 0) - (weeks[a].createdAt || 0)
            );

            if (weekIds.length === 0) {
                dropdown.innerHTML = '<option value="">No hay semanas</option>';
                return;
            }

            dropdown.innerHTML = weekIds.map(id => {
                const week = weeks[id];
                return `<option value="${id}" ${id === currentWeekId ? 'selected' : ''}>${week.name}</option>`;
            }).join('');
        }

        function selectWeek(weekId) {
            if (!weekId || !weeks[weekId]) return;

            currentWeekId = weekId;
            const week = weeks[weekId];

            // Cargar datos de la semana
            items = week.items || {};
            itemIdCounter = week.itemIdCounter || 0;
            currentList = week.currentList || 'general';

            // Actualizar UI
            document.getElementById('headerTitle').textContent = 'üõí ' + week.name;

            // Mostrar fechas del men√∫ si es de Paulina, sino la fecha de creaci√≥n
            if (week.sourceData && week.sourceData.fechas) {
                document.getElementById('headerSubtitle').textContent = week.sourceData.fechas;
            } else {
                document.getElementById('headerSubtitle').textContent = formatWeekDate(week.createdAt);
            }

            // Actualizar dropdown
            document.getElementById('weekDropdown').value = weekId;

            // Actualizar tabs
            document.querySelectorAll('.list-tab').forEach(t => t.classList.remove('active'));
            const tabIndex = currentList === 'general' ? 0 : 1;
            document.querySelectorAll('.list-tab')[tabIndex]?.classList.add('active');

            // Renderizar
            renderList();
            updateTotals();

            // Guardar selecci√≥n actual
            saveToLocalStorage();
        }

        function formatWeekDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return 'Creada el ' + date.toLocaleDateString('es-AR', {
                day: 'numeric',
                month: 'long'
            });
        }

        function openNewWeekModal() {
            document.getElementById('newWeekModal').classList.add('active');
            document.getElementById('weekNameInput').value = '';
            document.getElementById('weekNameInput').focus();
        }

        function closeNewWeekModal() {
            document.getElementById('newWeekModal').classList.remove('active');
        }

        async function createNewWeek() {
            const input = document.getElementById('weekNameInput');
            const name = input.value.trim();

            if (!name) {
                showToast('Escrib√≠ un nombre para la semana', 'warning');
                return;
            }

            const weekId = createWeekData(name);
            await saveWeekToCloud(weekId);

            closeNewWeekModal();
            renderWeeksDropdown();
            selectWeek(weekId);

            showToast('Semana creada', 'success');
        }

        async function deleteCurrentWeek() {
            if (!currentWeekId) return;

            const weekCount = Object.keys(weeks).length;
            if (weekCount <= 1) {
                showToast('No pod√©s eliminar la √∫nica semana', 'warning');
                return;
            }

            const weekName = weeks[currentWeekId]?.name || 'esta semana';
            if (!confirm(`¬øEliminar "${weekName}"? Se perder√°n todos los datos.`)) return;

            const weekIdToDelete = currentWeekId;

            // Eliminar de la nube
            await deleteWeekFromCloud(weekIdToDelete);

            // Eliminar localmente
            delete weeks[weekIdToDelete];

            // Seleccionar otra semana
            const remainingWeeks = Object.keys(weeks);
            currentWeekId = remainingWeeks[0];

            saveToLocalStorage();
            renderWeeksDropdown();
            selectWeek(currentWeekId);

            showToast('Semana eliminada', 'success');
        }

        // ==================== TOAST ====================
        function showToast(msg, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // ==================== IMPORT FROM PAULINA ====================
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('weekNumberInput').value = '';
            document.getElementById('importJsonInput').value = '';
            document.getElementById('weekNumberInput').focus();
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        async function importFromPaulina() {
            const weekNumber = document.getElementById('weekNumberInput').value;
            const jsonInput = document.getElementById('importJsonInput').value.trim();

            if (!weekNumber && !jsonInput) {
                showToast('Ingres√° un n√∫mero de semana o peg√° el JSON', 'warning');
                return;
            }

            let data;

            if (jsonInput) {
                // Parsear JSON pegado
                try {
                    data = JSON.parse(jsonInput);
                } catch (e) {
                    showToast('JSON inv√°lido', 'error');
                    return;
                }
            } else if (weekNumber) {
                // Buscar en Firestore si ya existe data scrapeada
                showToast('Buscando semana ' + weekNumber + '...', 'success');

                try {
                    // Primero intentar cargar desde Firestore (si el scraper lo subi√≥)
                    if (firebaseReady && db) {
                        const doc = await db.collection('paulina_menus').doc('semana_' + weekNumber).get();
                        if (doc.exists) {
                            data = doc.data();
                        }
                    }

                    // Si no existe, intentar scrapear en tiempo real (esto solo funciona si hay un proxy/backend)
                    if (!data) {
                        showToast('Semana ' + weekNumber + ' no encontrada. Ejecut√° el scraper primero.', 'warning');
                        return;
                    }
                } catch (error) {
                    console.error('Error buscando semana:', error);
                    showToast('Error al buscar la semana', 'error');
                    return;
                }
            }

            if (!data || (!data.general && !data.veggie)) {
                showToast('Datos inv√°lidos', 'error');
                return;
            }

            // Crear nueva semana con los datos importados
            const weekName = data.titulo || `Semana ${weekNumber || 'Importada'}`;
            const weekId = 'week_' + Date.now();

            let counter = 0;
            const newItems = {};

            // Procesar lista general
            if (data.general) {
                for (const [category, products] of Object.entries(data.general)) {
                    const categoryName = mapCategoryName(category);
                    for (const product of products) {
                        newItems[counter++] = {
                            name: product,
                            category: categoryName,
                            bought: false,
                            price: 0,
                            isExtra: false,
                            listType: 'general'
                        };
                    }
                }
            }

            // Procesar lista veggie
            if (data.veggie) {
                for (const [category, products] of Object.entries(data.veggie)) {
                    const categoryName = mapCategoryName(category);
                    for (const product of products) {
                        newItems[counter++] = {
                            name: product,
                            category: categoryName,
                            bought: false,
                            price: 0,
                            isExtra: false,
                            listType: 'veggie'
                        };
                    }
                }
            }

            weeks[weekId] = {
                id: weekId,
                name: weekName,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                items: newItems,
                itemIdCounter: counter,
                currentList: 'general',
                source: 'paulina',
                sourceData: {
                    semana: data.semana || weekNumber,
                    fechas: data.fechas || ''
                }
            };

            await saveWeekToCloud(weekId);
            closeImportModal();
            renderWeeksDropdown();
            selectWeek(weekId);

            const totalItems = Object.keys(newItems).length;
            showToast(`Importados ${totalItems} productos`, 'success');
        }

        function mapCategoryName(category) {
            // Mapear nombres de categor√≠a del scraper a los de la app
            const lower = category.toLowerCase();

            if (lower.includes('supermercado')) return 'Supermercado üè™';
            if (lower.includes('carne')) return 'Carnes ü•©';
            if (lower.includes('diet√©tica') || lower.includes('dietetica')) return 'Diet√©tica ü•ó';
            if (lower.includes('verduler√≠a') || lower.includes('verduleria')) return 'Verduler√≠a ü•¨';
            if (lower.includes('yapa')) return 'Yapa ‚≠ê';
            if (lower.includes('comod√≠n') || lower.includes('comodin')) return 'Comod√≠n üëë';
            if (lower.includes('casa') || lower.includes('seguro')) return 'Ya ten√©s ‚úÖ';

            // Si ya tiene emoji, devolverlo como est√°
            if (/[\u{1F300}-\u{1F9FF}]/u.test(category)) return category;

            return category;
        }

        // Funci√≥n para que el scraper pueda subir datos directamente
        async function uploadPaulinaMenu(weekNumber, data) {
            if (!firebaseReady || !db) {
                console.error('Firebase no disponible');
                return false;
            }

            try {
                await db.collection('paulina_menus').doc('semana_' + weekNumber).set({
                    ...data,
                    uploadedAt: Date.now()
                });
                console.log('Menu semana ' + weekNumber + ' subido correctamente');
                return true;
            } catch (error) {
                console.error('Error subiendo men√∫:', error);
                return false;
            }
        }
    </script>
</body>
</html>
