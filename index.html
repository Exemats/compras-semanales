<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üõí Compras Paulina</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3737/3737372.png">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #CF1015;
            --primary-dark: #a00d11;
            --success: #22c55e;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --border: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 70px;
        }

        /* ==================== HEADER ==================== */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 14px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.1rem;
        }

        .header .subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        /* ==================== WEEK SELECTOR ==================== */
        .week-selector {
            background: linear-gradient(135deg, #2d3748, #1a202c);
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .week-dropdown {
            flex: 1;
            min-width: 0;
            padding: 10px 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            background: white;
            color: var(--text);
            cursor: pointer;
        }

        .week-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .week-btn {
            padding: 10px 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            color: white;
            min-width: 42px;
            min-height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .week-btn:active {
            background: rgba(255,255,255,0.3);
        }

        .week-btn.danger {
            background: rgba(239, 68, 68, 0.7);
        }

        .sync-status {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.7);
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .sync-status:active {
            transform: scale(0.95);
        }

        .sync-status.synced {
            color: #4ade80;
            background: rgba(74, 222, 128, 0.15);
        }

        .sync-status.syncing {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.15);
        }

        .sync-status.error {
            color: #f87171;
            background: rgba(248, 113, 113, 0.15);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sync-status.syncing::before {
            content: '';
            width: 10px;
            height: 10px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 340px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal h3 {
            margin-bottom: 16px;
            font-size: 1.1rem;
        }

        .modal input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .modal input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-btns {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: var(--primary);
            color: white;
        }

        .modal-btn.secondary {
            background: #f0f0f0;
            color: var(--text);
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .no-weeks {
            text-align: center;
            padding: 24px;
            color: var(--text-light);
        }

        .no-weeks button {
            margin-top: 12px;
        }

        /* ==================== IMPORT MODAL ==================== */
        .import-modal {
            max-width: 380px;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
        }

        .import-step-title {
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .import-step-title.sm {
            margin-bottom: 16px;
            font-size: 1.1rem;
        }

        .import-step-title.xs {
            margin-bottom: 4px;
            font-size: 1.1rem;
        }

        .import-option-btn {
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .import-option-btn:active {
            border-color: var(--primary);
        }

        .import-option-icon {
            font-size: 1.5rem;
        }

        .import-option-text {
            text-align: left;
        }

        .import-option-name {
            font-weight: 600;
        }

        .import-option-desc {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .import-json-details {
            margin-top: 4px;
        }

        .import-json-summary {
            cursor: pointer;
            color: var(--text-light);
            font-size: 0.85rem;
            padding: 8px 0;
        }

        .import-json-textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.9rem;
            resize: none;
            margin-top: 8px;
        }

        .import-full-btn {
            width: 100%;
            margin-top: 8px;
        }

        .import-cancel-btn {
            width: 100%;
            margin-top: 16px;
        }

        .import-loading {
            text-align: center;
            padding: 24px;
            color: var(--text-light);
        }

        .import-weeks-list {
            max-height: 320px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .import-empty {
            display: none;
            text-align: center;
            padding: 24px;
        }

        .import-empty-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .import-empty-text {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .import-empty-hint {
            color: var(--text-light);
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .import-subtitle {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 12px;
        }

        .import-hint-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .import-checklist {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .import-checklist.tall {
            max-height: 180px;
            margin-bottom: 12px;
        }

        .import-quick-btns {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .import-quick-btns.lg {
            margin-bottom: 16px;
        }

        .import-quick-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.85rem;
        }

        .import-quick-btn.lg {
            padding: 10px;
            font-size: inherit;
        }

        /* Badges */
        .badge {
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.7rem;
            color: white;
        }

        .badge-primary { background: var(--primary); }
        .badge-veggie { background: #4caf50; }
        .badge-dias { background: #2196f3; }
        .badge-platos { background: #ff9800; }

        /* Week cards in import */
        .week-card {
            padding: 14px 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
        }

        .week-card:hover, .week-card:active {
            border-color: var(--primary);
        }

        .week-card-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .week-card-dates {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 2px;
        }

        .week-card-badges {
            margin-top: 8px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        /* Checkbox rows (dias / platos) */
        .check-row {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            gap: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .check-row:last-child {
            border-bottom: none;
        }

        .check-row input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .check-row label {
            flex: 1;
            cursor: pointer;
            pointer-events: none;
        }

        .check-row-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .check-row-subtitle {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 2px;
        }

        .import-section {
            margin-bottom: 16px;
        }

        .import-toggle-row {
            display: flex;
            gap: 8px;
        }

        .import-toggle {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            background: var(--bg);
            color: var(--text);
            transition: all 0.15s;
        }

        .import-toggle.active {
            border-color: var(--primary);
            background: #fff0f0;
            color: var(--primary);
        }

        .import-toggle.veggie-active {
            border-color: #4caf50;
            background: #f0fff0;
            color: #2e7d32;
        }

        .import-extras {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .import-extra-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
            background: white;
        }

        .import-extra-toggle.active {
            border-color: var(--primary);
            background: #fff8f8;
        }

        .import-extra-toggle input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .import-extra-info {
            flex: 1;
        }

        .import-extra-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .import-extra-desc {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 2px;
        }

        .import-error-msg {
            color: #dc2626;
            text-align: center;
            padding: 16px;
        }

        .import-info-msg {
            color: var(--primary);
        }

        /* ==================== QUICK REGISTER ==================== */
        .quick-register {
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            padding: 16px;
            color: white;
            position: sticky;
            top: 52px;
            z-index: 99;
        }

        .register-row {
            display: flex;
            gap: 8px;
        }

        .register-input {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            color: var(--text);
        }

        .register-input::placeholder {
            color: #999;
        }

        .register-input:focus {
            outline: 2px solid var(--success);
        }

        .btn-register {
            padding: 14px 20px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-voice {
            padding: 14px 16px;
            background: var(--info);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .btn-voice.recording {
            background: #dc3545;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .register-hint {
            font-size: 0.75rem;
            opacity: 0.85;
            margin-top: 10px;
        }

        .register-hint code {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Match Preview */
        .match-preview {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
            border-radius: 8px;
            padding: 10px 12px;
            margin-top: 12px;
            display: none;
        }

        .match-preview.active {
            display: block;
        }

        .match-preview.no-match {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
        }

        .match-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 0.9rem;
        }

        .match-item .product {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .match-item .status {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.3);
        }

        .match-item .price {
            font-weight: bold;
            color: #4ade80;
        }

        /* ==================== TOTALS BAR ==================== */
        .totals-bar {
            display: flex;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .total-box {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-right: 1px solid var(--border);
        }

        .total-box:last-child {
            border-right: none;
        }

        .total-box .value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--success);
        }

        .total-box .value.pending {
            color: var(--warning);
        }

        .total-box .label {
            font-size: 0.7rem;
            color: var(--text-light);
            text-transform: uppercase;
        }

        /* ==================== PERSON TOTALS ==================== */
        .person-totals {
            display: flex;
            gap: 8px;
            padding: 8px 16px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .person-totals:empty {
            display: none;
        }

        .person-total {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .person-total .name {
            font-weight: 500;
            color: var(--text-light);
        }

        .person-total .amount {
            font-weight: bold;
            color: var(--success);
        }

        /* ==================== SEARCH BAR ==================== */
        .search-bar {
            display: flex;
            padding: 8px 16px;
            gap: 8px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .search-bar input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--bg);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .clear-search {
            padding: 0 14px;
            border: none;
            background: var(--border);
            border-radius: 8px;
            font-size: 1.2rem;
            color: var(--text-light);
            cursor: pointer;
            display: none;
        }

        .clear-search.visible {
            display: block;
        }

        /* ==================== LIST TABS ==================== */
        .list-tabs {
            display: flex;
            padding: 8px 16px;
            gap: 8px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }

        .list-tab {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            background: #f0f0f0;
            color: var(--text);
        }

        .list-tab.active {
            background: var(--primary);
            color: white;
        }

        /* ==================== SHOPPING LIST ==================== */
        .list-container {
            padding: 12px;
        }

        .category {
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 10px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        .category-header {
            padding: 12px 14px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            cursor: pointer;
        }

        .category-header .count {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--text-light);
            font-weight: normal;
        }

        .category-header .cat-total {
            font-size: 0.8rem;
            color: var(--success);
            font-weight: bold;
        }

        .category.collapsed .category-content {
            display: none;
        }

        .category-header .toggle {
            font-size: 0.7rem;
            transition: transform 0.2s;
        }

        .category.collapsed .toggle {
            transform: rotate(-90deg);
        }

        /* Items */
        .item {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item.bought {
            background: linear-gradient(90deg, #f0fdf4, #dcfce7);
        }

        .item.bought .item-name {
            text-decoration: line-through;
            color: var(--text-light);
        }

        .item.highlight {
            animation: highlightPulse 1s ease;
        }

        @keyframes highlightPulse {
            0% { background: #fef08a; }
            100% { background: #f0fdf4; }
        }

        .item-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .item.bought .item-check {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-size: 0.9rem;
            line-height: 1.3;
        }

        .item-price {
            font-size: 0.95rem;
            font-weight: bold;
            color: var(--success);
            margin-left: 10px;
            white-space: nowrap;
        }

        /* Extra indicator */
        .item.extra {
            background: #fffbeb;
            border-left: 3px solid var(--warning);
        }

        .item.extra .item-check {
            border-color: var(--warning);
        }

        .item.extra.bought .item-check {
            background: var(--warning);
            border-color: var(--warning);
        }

        .extra-badge {
            font-size: 0.65rem;
            background: var(--warning);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        .bought-by {
            font-size: 0.65rem;
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            opacity: 0.8;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 1.1rem;
            padding: 4px 8px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .delete-btn:hover {
            opacity: 1;
        }

        .delete-btn:active {
            opacity: 1;
            transform: scale(0.95);
        }

        /* Confirm delete modal */
        .confirm-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.2);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 250;
        }

        .confirm-modal.active {
            transform: translateY(0);
        }

        .confirm-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 240;
        }

        .confirm-modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .confirm-modal h4 {
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .confirm-modal p {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        .confirm-modal-btns {
            display: flex;
            gap: 10px;
        }

        .confirm-modal-btns button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .confirm-modal-btns .cancel-btn {
            background: #f0f0f0;
            color: var(--text);
        }

        .confirm-modal-btns .delete-confirm-btn {
            background: #ef4444;
            color: white;
        }

        /* ==================== BOTTOM ACTIONS ==================== */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            display: flex;
            gap: 10px;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .bottom-btn {
            flex: 1;
            padding: 14px 12px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s, opacity 0.1s;
        }

        .bottom-btn:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .bottom-btn.primary {
            background: var(--primary);
            color: white;
            flex: 2;
        }

        .bottom-btn.secondary {
            background: #f0f0f0;
            color: var(--text);
        }

        .bottom-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .bottom-btn.small {
            flex: 0;
            padding: 14px 16px;
        }

        /* ==================== TOAST ==================== */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 90%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: #ef4444; }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }

        /* ==================== EMPTY STATE ==================== */
        .empty-message {
            text-align: center;
            padding: 30px;
            color: var(--text-light);
        }

        /* ==================== LOGIN SCREEN ==================== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 20px;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            max-width: 340px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .login-card h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .login-card h2 {
            font-size: 1.2rem;
            color: var(--text);
            margin-bottom: 8px;
        }

        .login-card p {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 30px;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 14px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: white;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .google-btn:hover {
            background: #f8f8f8;
            border-color: #ccc;
        }

        .google-btn:active {
            transform: scale(0.98);
        }

        .google-btn img {
            width: 20px;
            height: 20px;
        }

        .login-error {
            margin-top: 16px;
            padding: 12px;
            background: #fef2f2;
            border-radius: 8px;
            color: #dc2626;
            font-size: 0.85rem;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* User Info Bar */
        .user-bar {
            background: linear-gradient(135deg, #1f2937, #111827);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 0.8rem;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .user-name {
            flex: 1;
            opacity: 0.9;
        }

        .logout-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .logout-btn:active {
            background: rgba(255,255,255,0.2);
        }

        /* Import button */
        .import-btn {
            background: #8b5cf6;
            color: white;
        }

        .app-content {
            display: none;
        }

        .app-content.visible {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <h1>üõí</h1>
            <h2>Compras Semanales</h2>
            <p>Inici√° sesi√≥n para sincronizar tus listas de compras</p>
            <button class="google-btn" onclick="signInWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                Continuar con Google
            </button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <!-- App Content (hidden until login) -->
    <div class="app-content" id="appContent">
        <!-- User Bar -->
        <div class="user-bar" id="userBar">
            <div class="user-avatar" id="userAvatar">?</div>
            <span class="user-name" id="userName">Usuario</span>
            <button class="logout-btn" onclick="signOutUser()">Salir</button>
        </div>

        <div class="header">
            <h1 id="headerTitle">üõí Compras Semanales</h1>
            <div class="subtitle" id="headerSubtitle">Seleccion√° una semana</div>
        </div>

        <!-- Week Selector -->
        <div class="week-selector">
            <select id="weekDropdown" class="week-dropdown" onchange="selectWeek(this.value)">
                <option value="">Cargando semanas...</option>
            </select>
            <div class="week-actions">
                <button class="week-btn" onclick="openImportModal()" title="Nueva lista">‚ûï</button>
                <button class="week-btn danger" onclick="deleteCurrentWeek()" title="Eliminar semana">üóëÔ∏è</button>
                <button class="week-btn" onclick="forceSync()" title="Sincronizar" id="syncBtn">üîÑ</button>
                <div class="sync-status" id="syncStatus" onclick="forceSync()">
                    <span>‚òÅÔ∏è</span> <span id="syncText">Local</span>
                </div>
            </div>
        </div>

        <!-- Quick Register -->
        <div class="quick-register">
            <div class="register-row">
                <input type="text"
                       id="registerInput"
                       class="register-input"
                       placeholder="leche 2500, pan 1200..."
                       autocomplete="off">
                <button class="btn-register" onclick="processInput()">‚úì</button>
                <button class="btn-voice" id="voiceBtn" onclick="toggleVoice()">üé§</button>
            </div>
            <div class="register-hint">
                üí° Escrib√≠ el producto y precio: <code>leche 2500</code> ‚Äî Se tacha de la lista y suma al total
            </div>
            <div class="match-preview" id="matchPreview"></div>
        </div>

        <!-- Totals -->
        <div class="totals-bar">
            <div class="total-box">
                <div class="value" id="totalSpent">$0</div>
                <div class="label">Gastado</div>
            </div>
            <div class="total-box">
                <div class="value pending" id="pendingCount">0</div>
                <div class="label">Pendientes</div>
            </div>
            <div class="total-box">
                <div class="value" id="boughtCount">0</div>
                <div class="label">Comprados</div>
            </div>
        </div>

        <!-- Gastos por persona -->
        <div class="person-totals" id="personTotals"></div>

        <!-- Search Bar -->
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="üîç Buscar item..." oninput="filterList()">
            <button class="clear-search" onclick="clearSearch()" id="clearSearchBtn">√ó</button>
        </div>

        <!-- List Type Tabs -->
        <div class="list-tabs">
            <button class="list-tab active" onclick="switchList('general', event)">üçñ General</button>
            <button class="list-tab" onclick="switchList('veggie', event)">ü•¨ Vegetariana</button>
        </div>

        <!-- Shopping List -->
        <div class="list-container" id="listContainer"></div>

        <!-- Bottom Actions -->
        <div class="bottom-bar">
            <button class="bottom-btn secondary small" onclick="resetAll()">üóëÔ∏è</button>
            <button class="bottom-btn primary" onclick="openImportModal()">üì• Nueva lista</button>
            <button class="bottom-btn secondary" onclick="addExtra()">‚ûï</button>
            <button class="bottom-btn whatsapp small" onclick="shareWhatsApp()">üì±</button>
        </div>
    </div><!-- End app-content -->

    <!-- Modal Nueva Lista -->
    <div class="modal-overlay" id="importModal">
        <div class="modal import-modal">
            <!-- Paso 1: Seleccionar fuente -->
            <div id="importStep1">
                <h3 class="import-step-title">üìù Nueva lista</h3>

                <button class="import-option-btn" onclick="createEmptyList()">
                    <span class="import-option-icon">üìã</span>
                    <div class="import-option-text">
                        <div class="import-option-name">Lista vac√≠a</div>
                        <div class="import-option-desc">Crear lista nueva desde cero</div>
                    </div>
                </button>

                <button class="import-option-btn" onclick="browseAvailableWeeks()">
                    <span class="import-option-icon">üç≥</span>
                    <div class="import-option-text">
                        <div class="import-option-name">Importar de Paulina</div>
                        <div class="import-option-desc">Men√∫ semanal de Paulina Cocina</div>
                    </div>
                </button>

                <details class="import-json-details">
                    <summary class="import-json-summary">Pegar JSON manualmente...</summary>
                    <textarea id="importJsonInput" class="import-json-textarea"
                              placeholder="Peg√° el JSON del scraper aqu√≠..."></textarea>
                    <button onclick="loadFromJson()" class="modal-btn secondary import-full-btn">
                        Importar JSON
                    </button>
                </details>

                <button class="modal-btn secondary import-cancel-btn" onclick="closeImportModal()">
                    Cancelar
                </button>
            </div>

            <!-- Paso 2: Semanas disponibles -->
            <div id="importStep2" style="display: none;">
                <h3 class="import-step-title sm">üç≥ Semanas disponibles</h3>

                <div id="availableWeeksLoading" class="import-loading">
                    Cargando semanas...
                </div>

                <div id="availableWeeksList" class="import-weeks-list"></div>

                <div id="availableWeeksEmpty" class="import-empty">
                    <div class="import-empty-icon">üì≠</div>
                    <div class="import-empty-text">No hay semanas disponibles.</div>
                    <div class="import-empty-hint">Ejecut√° el scraper primero para subir men√∫s.</div>
                </div>

                <button class="modal-btn secondary import-full-btn" onclick="backToStep1()">
                    ‚Üê Atr√°s
                </button>
            </div>

            <!-- Paso 3: Configuraci√≥n modular de importaci√≥n -->
            <div id="importStep3" style="display: none;">
                <h3 class="import-step-title xs" id="menuTitle">Men√∫</h3>
                <p class="import-subtitle" id="menuDates"></p>

                <!-- 1. Tipo de lista: General / Vegetariano -->
                <div id="listTypeSection" class="import-section">
                    <div class="import-hint-label">Tipo de lista:</div>
                    <div class="import-toggle-row">
                        <button class="import-toggle active" id="toggleGeneral" onclick="selectListType('general')">üçñ General</button>
                        <button class="import-toggle" id="toggleVeggie" onclick="selectListType('veggie')" style="display:none;">ü•¨ Vegetariana</button>
                    </div>
                </div>

                <!-- 2. D√≠as a incluir (si hay recetas por d√≠a) -->
                <div id="diasSection" style="display: none;">
                    <div class="import-hint-label">D√≠as a incluir:</div>
                    <div id="diasContainer" class="import-checklist"></div>
                    <div class="import-quick-btns">
                        <button class="modal-btn secondary import-quick-btn" onclick="selectAllDias()">Todos</button>
                        <button class="modal-btn secondary import-quick-btn" onclick="selectNoneDias()">Ninguno</button>
                    </div>
                </div>

                <!-- 2b. Platos individuales (para men√∫s especiales sin recetas por d√≠a) -->
                <div id="platosSection" style="display: none;">
                    <div class="import-hint-label">Platos a incluir:</div>
                    <div id="platosContainer" class="import-checklist tall"></div>
                    <div class="import-quick-btns lg">
                        <button class="modal-btn secondary import-quick-btn lg" onclick="selectAllPlatos()">Todos</button>
                        <button class="modal-btn secondary import-quick-btn lg" onclick="selectNonePlatos()">Ninguno</button>
                    </div>
                </div>

                <!-- 3. Categor√≠as extras: Yapa / Comod√≠n -->
                <div id="extrasSection" style="display: none;">
                    <div class="import-hint-label">Categor√≠as extras:</div>
                    <div id="extrasContainer" class="import-extras"></div>
                </div>

                <div class="modal-btns">
                    <button class="modal-btn secondary" onclick="backToStep2()">‚Üê Atr√°s</button>
                    <button class="modal-btn primary" onclick="executeImport()">Crear lista</button>
                </div>
            </div>

            <button class="modal-close" onclick="closeImportModal()">√ó</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Confirm Delete Modal -->
    <div class="confirm-modal-backdrop" id="confirmBackdrop" onclick="closeConfirmModal()"></div>
    <div class="confirm-modal" id="confirmModal">
        <h4 id="confirmTitle">Eliminar item</h4>
        <p id="confirmMessage">Este item se eliminar√° de la lista.</p>
        <div class="confirm-modal-btns">
            <button class="cancel-btn" onclick="closeConfirmModal()">Cancelar</button>
            <button class="delete-confirm-btn" id="confirmDeleteBtn">Eliminar</button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAv_ko7n9m9dG-NUuKkz8jLS1vQOE3NOgs",
          authDomain: "compras-semanales-72dd1.firebaseapp.com",
          projectId: "compras-semanales-72dd1",
          storageBucket: "compras-semanales-72dd1.firebasestorage.app",
          messagingSenderId: "1079679650059",
          appId: "1:1079679650059:web:dd70afc49639b2cde27a0e",
          measurementId: "G-YPZ2K4SX5E"
        };

        // Usuarios autorizados
        const ALLOWED_EMAILS = [
            'matiarona@gmail.com',
            'vickyswag02@gmail.com'
        ];

        // Initialize Firebase
        let db = null;
        let auth = null;
        let currentUser = null;
        let firebaseReady = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            firebaseReady = true;
            console.log('Firebase inicializado');
        } catch (error) {
            console.warn('Firebase no disponible, usando solo localStorage:', error);
        }

        // ==================== AUTHENTICATION ====================
        function isEmailAllowed(email) {
            return ALLOWED_EMAILS.includes(email.toLowerCase());
        }

        async function signInWithGoogle() {
            if (!auth) {
                showLoginError('Firebase no est√° configurado. Revis√° SETUP_FIREBASE.md');
                return;
            }

            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({ prompt: 'select_account' });

                const result = await auth.signInWithPopup(provider);
                const user = result.user;

                // Verificar si el email est√° autorizado
                if (!isEmailAllowed(user.email)) {
                    await auth.signOut();
                    showLoginError(`El email ${user.email} no est√° autorizado. Solo Mati y Vicky pueden usar esta app.`);
                    return;
                }

                // Login exitoso, el observer manejar√° el resto
            } catch (error) {
                console.error('Error en login:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    return; // Usuario cerr√≥ el popup, no mostrar error
                }
                showLoginError('Error al iniciar sesi√≥n: ' + error.message);
            }
        }

        async function signOutUser() {
            if (!auth) return;

            try {
                await auth.signOut();
                showLoginScreen();
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContent').classList.remove('visible');
        }

        function showAppContent() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContent').classList.add('visible');
        }

        function showLoginError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function updateUserUI(user) {
            if (!user) return;

            const avatar = document.getElementById('userAvatar');
            const name = document.getElementById('userName');

            if (user.photoURL) {
                avatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar">`;
            } else {
                avatar.textContent = user.email.charAt(0).toUpperCase();
            }

            // Mostrar nombre corto
            const firstName = user.displayName ? user.displayName.split(' ')[0] : user.email.split('@')[0];
            name.textContent = firstName;
        }

        // Auth state observer
        if (auth) {
            auth.onAuthStateChanged(async (user) => {
                if (user && isEmailAllowed(user.email)) {
                    currentUser = user;
                    updateUserUI(user);
                    showAppContent();
                    await loadAllData();
                } else {
                    currentUser = null;
                    showLoginScreen();
                }
            });
        }

        // ==================== DATA ====================
        let currentList = 'general';
        let currentWeekId = null;
        let weeks = {}; // weekId -> { name, createdAt, items, itemIdCounter, currentList }
        let items = {}; // id -> { name, category, bought, price, isExtra }
        let searchFilter = ''; // Filtro de b√∫squeda actual
        let itemIdCounter = 0;


        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Setup input listeners
            document.getElementById('registerInput').addEventListener('input', showPreview);
            document.getElementById('registerInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') processInput();
            });

            // Si no hay Firebase Auth configurado, mostrar la app directamente (modo local)
            if (!auth) {
                showAppContent();
                await loadAllData();
            }
            // Si hay auth, el observer se encargar√° de cargar los datos
        });

        async function loadAllData() {
            updateSyncStatus('syncing', 'Cargando...');

            // Primero cargar de localStorage
            loadFromLocalStorage();

            // Si Firebase est√° disponible, sincronizar
            if (firebaseReady) {
                try {
                    await syncFromFirestore();
                    updateSyncStatus('synced', 'Sincronizado');
                } catch (error) {
                    console.error('Error syncing from Firestore:', error);
                    updateSyncStatus('error', 'Sin conexi√≥n');
                }
            } else {
                updateSyncStatus('error', 'Solo local');
            }

            // Renderizar semanas disponibles
            renderWeeksDropdown();

            // Si no hay semanas, crear una por defecto
            if (Object.keys(weeks).length === 0) {
                const defaultWeekId = createWeekData('Semana 1');
                currentWeekId = defaultWeekId;
                await saveWeekToCloud(defaultWeekId);
            }

            // Seleccionar semana actual
            if (currentWeekId && weeks[currentWeekId]) {
                selectWeek(currentWeekId);
            } else {
                // Seleccionar la m√°s reciente
                const weekIds = Object.keys(weeks).sort((a, b) =>
                    (weeks[b].createdAt || 0) - (weeks[a].createdAt || 0)
                );
                if (weekIds.length > 0) {
                    selectWeek(weekIds[0]);
                }
            }
        }

        // ==================== MATCHING ====================
        function normalizeText(text) {
            return text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove accents
                .replace(/[^a-z0-9\s]/g, ' ')
                .trim();
        }

        // Normalizaci√≥n m√°s agresiva para detectar duplicados de ingredientes
        // Ej: "1 pur√© de tomate (usar√°s 2 cdas.)" y "1 pur√© de tomate (vas a usar 2 cdas.)"
        // ambos se normalizan a "pure tomate"
        function normalizeIngredient(text) {
            let normalized = text.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, ''); // Remove accents

            // Remover contenido entre par√©ntesis
            normalized = normalized.replace(/\([^)]*\)/g, '');

            // Remover cantidades al inicio: "1 ", "2 ", "1/2 ", "100g ", etc.
            normalized = normalized.replace(/^[\d\s\/¬Ω¬º¬æ,.]+\s*(g|gr|kg|ml|l|lt|lts|litro|litros|cdas?|cucharadas?|tazas?|unidad|unidades|paquete|paquetes|lata|latas|sobre|sobres)?\s*/i, '');

            // Remover palabras comunes de cantidad al inicio
            normalized = normalized.replace(/^(un|una|uno|dos|tres|cuatro|cinco|medio|media|pizca|chorro|poco|mucho)\s+/gi, '');

            // Remover caracteres especiales y n√∫meros restantes
            normalized = normalized.replace(/[^a-z\s]/g, ' ');

            // Colapsar espacios m√∫ltiples
            normalized = normalized.replace(/\s+/g, ' ').trim();

            // Extraer las primeras 3 palabras significativas (el core del ingrediente)
            const words = normalized.split(' ').filter(w => w.length > 1);
            return words.slice(0, 3).join(' ');
        }

        function findMatches(searchText) {
            const normalized = normalizeText(searchText);
            const words = normalized.split(/\s+/).filter(w => w.length > 2);
            
            if (words.length === 0) return [];

            const matches = [];
            
            for (const [id, item] of Object.entries(items)) {
                if (item.listType !== currentList) continue;
                
                const itemNormalized = normalizeText(item.name);
                
                // Check if any search word matches
                let score = 0;
                for (const word of words) {
                    if (itemNormalized.includes(word)) {
                        score += word.length;
                        // Bonus for word at start
                        if (itemNormalized.startsWith(word)) score += 5;
                    }
                }
                
                if (score > 0) {
                    matches.push({ id: parseInt(id), item, score });
                }
            }
            
            // Sort by score descending
            matches.sort((a, b) => b.score - a.score);
            
            return matches.slice(0, 3); // Top 3 matches
        }

        // ==================== INPUT PROCESSING ====================
        function parseInput(text) {
            const results = [];
            const parts = text.split(/[,;]/);
            
            for (let part of parts) {
                part = part.trim();
                if (!part) continue;

                // Match: "producto 1234" or "producto $1.234"
                const match = part.match(/^(.+?)\s+\$?(\d{1,3}(?:[.,]\d{3})*|\d+)\s*$/);
                
                if (match) {
                    const searchText = match[1].trim();
                    let price = match[2].replace(/\./g, '').replace(',', '.');
                    price = parseInt(price) || 0;
                    
                    const matches = findMatches(searchText);
                    
                    results.push({
                        searchText,
                        price,
                        matches,
                        bestMatch: matches.length > 0 ? matches[0] : null
                    });
                }
            }
            
            return results;
        }

        function showPreview(e) {
            const text = e.target.value;
            const preview = document.getElementById('matchPreview');
            
            if (!text.trim()) {
                preview.classList.remove('active');
                return;
            }

            const parsed = parseInput(text);
            
            if (parsed.length === 0) {
                preview.classList.remove('active');
                return;
            }

            let html = '';
            let hasNoMatch = false;

            for (const item of parsed) {
                if (item.bestMatch) {
                    const alreadyBought = item.bestMatch.item.bought;
                    html += `
                        <div class="match-item">
                            <div class="product">
                                <span>${alreadyBought ? '‚úì' : '‚Üí'}</span>
                                <span>${item.bestMatch.item.name}</span>
                            </div>
                            <span class="price">$${item.price.toLocaleString('es-AR')}</span>
                        </div>
                    `;
                } else {
                    hasNoMatch = true;
                    html += `
                        <div class="match-item">
                            <div class="product">
                                <span>‚ûï</span>
                                <span>"${item.searchText}" (se agregar√° como extra)</span>
                            </div>
                            <span class="price">$${item.price.toLocaleString('es-AR')}</span>
                        </div>
                    `;
                }
            }

            preview.innerHTML = html;
            preview.classList.add('active');
            preview.classList.toggle('no-match', hasNoMatch);
        }

        function processInput() {
            const input = document.getElementById('registerInput');
            const text = input.value.trim();

            if (!text) return;

            const parsed = parseInput(text);

            if (parsed.length === 0) {
                showToast('Agreg√° el precio. Ej: leche 2500', 'warning');
                return;
            }

            let totalAdded = 0;
            let itemsProcessed = [];

            for (const item of parsed) {
                if (item.bestMatch) {
                    // Mark as bought and set price
                    const id = item.bestMatch.id;
                    items[id].bought = true;
                    items[id].price = item.price;
                    items[id].boughtBy = currentUser?.displayName || currentUser?.email || 'An√≥nimo';
                    items[id].itemUpdatedAt = Date.now();
                    totalAdded += item.price;
                    itemsProcessed.push(items[id].name);

                    // Highlight animation
                    setTimeout(() => {
                        const el = document.querySelector(`[data-id="${id}"]`);
                        if (el) {
                            el.classList.add('highlight');
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                } else {
                    // Verificar si ya existe un extra con el mismo nombre
                    const normalizedName = normalizeText(item.searchText);
                    const existingExtra = Object.entries(items).find(([id, i]) =>
                        i.listType === currentList && i.isExtra && normalizeText(i.name) === normalizedName
                    );

                    if (existingExtra) {
                        // Actualizar el extra existente
                        const [existingId, existingItem] = existingExtra;
                        existingItem.bought = true;
                        existingItem.price = (existingItem.price || 0) + item.price;
                        existingItem.boughtBy = currentUser?.displayName || currentUser?.email || 'An√≥nimo';
                        existingItem.itemUpdatedAt = Date.now();
                        totalAdded += item.price;
                        itemsProcessed.push(existingItem.name + ' (actualizado)');
                    } else {
                        // Add as new extra
                        const newId = itemIdCounter++;
                        items[newId] = {
                            name: item.searchText.charAt(0).toUpperCase() + item.searchText.slice(1),
                            category: 'Extras ‚ûï',
                            bought: true,
                            price: item.price,
                            isExtra: true,
                            listType: currentList,
                            boughtBy: currentUser?.displayName || currentUser?.email || 'An√≥nimo',
                            itemUpdatedAt: Date.now()
                        };
                        totalAdded += item.price;
                        itemsProcessed.push(items[newId].name + ' (extra)');
                    }
                }
            }

            input.value = '';
            document.getElementById('matchPreview').classList.remove('active');

            renderList();
            updateTotals();
            saveData();

            showToast(`‚úì +$${totalAdded.toLocaleString('es-AR')}`, 'success');
        }

        // ==================== RENDER ====================
        function renderList() {
            const container = document.getElementById('listContainer');
            
            // Group items by category
            const categories = {};
            
            for (const [id, item] of Object.entries(items)) {
                if (item.listType !== currentList) continue;

                // Aplicar filtro de b√∫squeda
                if (searchFilter && !item.name.toLowerCase().includes(searchFilter)) {
                    continue;
                }

                const cat = item.category;
                if (!categories[cat]) {
                    categories[cat] = [];
                }
                categories[cat].push({ id: parseInt(id), ...item });
            }

            // Sort: unbought first, then by name
            for (const cat of Object.keys(categories)) {
                categories[cat].sort((a, b) => {
                    if (a.bought !== b.bought) return a.bought ? 1 : -1;
                    return a.name.localeCompare(b.name);
                });
            }

            // Define category order
            const categoryOrder = [
                'Supermercado üè™',
                'Carnes ü•©',
                'Diet√©tica ü•ó',
                'Verduler√≠a ü•¨',
                'Yapa ‚≠ê',
                'Comod√≠n üëë',
                'Extras ‚ûï'
            ];

            let html = '';

            for (const catName of categoryOrder) {
                const catItems = categories[catName];
                if (!catItems || catItems.length === 0) continue;

                const boughtCount = catItems.filter(i => i.bought).length;
                const catTotal = catItems.reduce((sum, i) => sum + (i.price || 0), 0);

                html += `
                    <div class="category" data-category="${catName}">
                        <div class="category-header" onclick="toggleCategory(this)">
                            <span>${catName}</span>
                            <span class="count">${boughtCount}/${catItems.length}</span>
                            ${catTotal > 0 ? `<span class="cat-total">$${catTotal.toLocaleString('es-AR')}</span>` : ''}
                            <span class="toggle">‚ñº</span>
                        </div>
                        <div class="category-content">
                            ${catItems.map(item => `
                                <div class="item ${item.bought ? 'bought' : ''} ${item.isExtra ? 'extra' : ''}"
                                     data-id="${item.id}" onclick="toggleItem(${item.id})">
                                    <div class="item-check">${item.bought ? '‚úì' : ''}</div>
                                    <div class="item-info">
                                        <span class="item-name">${item.name}</span>
                                        ${item.isExtra ? '<span class="extra-badge">EXTRA</span>' : ''}
                                        ${item.boughtBy ? `<span class="bought-by">${item.boughtBy.split(' ')[0]}</span>` : ''}
                                    </div>
                                    ${item.bought ? `<span class="item-price" onclick="editPrice(${item.id}, event)">$${(item.price || 0).toLocaleString('es-AR')}</span>` : ''}
                                    <button class="delete-btn" onclick="confirmDeleteItem(${item.id}, event)" title="Eliminar">√ó</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html || '<div class="empty-message">No hay items</div>';
        }

        function toggleCategory(header) {
            header.parentElement.classList.toggle('collapsed');
        }

        function filterList() {
            const input = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            searchFilter = input.value.toLowerCase().trim();

            // Mostrar/ocultar bot√≥n de limpiar
            if (searchFilter) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }

            renderList();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchFilter = '';
            document.getElementById('clearSearchBtn').classList.remove('visible');
            renderList();
        }

        function updateTotals() {
            let totalSpent = 0;
            let pending = 0;
            let bought = 0;
            const byPerson = {}; // { nombre: total }

            for (const [id, item] of Object.entries(items)) {
                if (item.listType !== currentList) continue;

                if (item.bought) {
                    bought++;
                    totalSpent += item.price || 0;

                    // Sumar por persona
                    if (item.boughtBy && item.price > 0) {
                        const name = item.boughtBy.split(' ')[0]; // Solo el primer nombre
                        byPerson[name] = (byPerson[name] || 0) + item.price;
                    }
                } else {
                    pending++;
                }
            }

            document.getElementById('totalSpent').textContent = `$${totalSpent.toLocaleString('es-AR')}`;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('boughtCount').textContent = bought;

            // Mostrar totales por persona
            const personTotalsDiv = document.getElementById('personTotals');
            const personNames = Object.keys(byPerson);

            if (personNames.length > 0) {
                personTotalsDiv.innerHTML = personNames.map(name => `
                    <div class="person-total">
                        <span class="name">${name}:</span>
                        <span class="amount">$${byPerson[name].toLocaleString('es-AR')}</span>
                    </div>
                `).join('');
            } else {
                personTotalsDiv.innerHTML = '';
            }
        }

        // ==================== ACTIONS ====================
        function switchList(type, event) {
            currentList = type;
            document.querySelectorAll('.list-tab').forEach(t => t.classList.remove('active'));
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                const tabIndex = type === 'general' ? 0 : 1;
                document.querySelectorAll('.list-tab')[tabIndex]?.classList.add('active');
            }

            renderList();
            updateTotals();
            saveData();
        }

        function addExtra() {
            const name = prompt('Nombre del producto extra:');
            if (!name) return;

            // Verificar duplicados
            const normalizedName = normalizeText(name);
            const existingItem = Object.entries(items).find(([id, item]) =>
                item.listType === currentList && normalizeText(item.name) === normalizedName
            );

            if (existingItem) {
                showToast(`"${existingItem[1].name}" ya est√° en la lista`, 'warning');
                // Scroll al item existente
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${existingItem[0]}"]`);
                    if (el) {
                        el.classList.add('highlight');
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
                return;
            }

            const priceStr = prompt('Precio (o dej√° vac√≠o):');
            const price = parseInt(priceStr) || 0;

            const newId = itemIdCounter++;
            items[newId] = {
                name: name.charAt(0).toUpperCase() + name.slice(1),
                category: 'Extras ‚ûï',
                bought: price > 0,
                price: price,
                isExtra: true,
                listType: currentList,
                boughtBy: price > 0 ? (currentUser?.displayName || currentUser?.email || 'An√≥nimo') : null,
                itemUpdatedAt: Date.now()
            };

            renderList();
            updateTotals();
            saveData();
            showToast('Extra agregado', 'success');
        }

        function toggleItem(id) {
            const strId = String(id);
            if (!items[strId]) return;

            const item = items[strId];
            if (item.bought) {
                // Desmarcar
                item.bought = false;
                item.price = 0;
                item.boughtBy = null;
                item.itemUpdatedAt = Date.now();
                showToast('Item desmarcado', 'info');
            } else {
                // Marcar como comprado - pedir precio
                const priceStr = prompt(`Precio de "${item.name}":`);
                if (priceStr === null) return; // Cancel√≥
                const price = parseInt(priceStr) || 0;
                item.bought = true;
                item.price = price;
                item.boughtBy = currentUser?.displayName || currentUser?.email || 'An√≥nimo';
                item.itemUpdatedAt = Date.now();
                showToast('Item marcado', 'success');
            }

            renderList();
            updateTotals();
            saveData();
        }

        function editPrice(id, event) {
            event.stopPropagation();
            const strId = String(id);
            if (!items[strId]) return;

            const item = items[strId];
            const newPrice = prompt(`Nuevo precio de "${item.name}":`, item.price || 0);
            if (newPrice === null) return; // Cancel√≥

            item.price = parseInt(newPrice) || 0;
            item.itemUpdatedAt = Date.now();
            renderList();
            updateTotals();
            saveData();
            showToast('Precio actualizado', 'success');
        }

        let pendingDeleteId = null;

        function confirmDeleteItem(id, event) {
            if (event) event.stopPropagation();
            const strId = String(id);
            if (!items[strId]) return;

            const item = items[strId];
            pendingDeleteId = strId;

            document.getElementById('confirmTitle').textContent = 'Eliminar item';
            document.getElementById('confirmMessage').textContent = `¬øEliminar "${item.name}" de la lista?`;
            document.getElementById('confirmBackdrop').classList.add('active');
            document.getElementById('confirmModal').classList.add('active');
            document.getElementById('confirmDeleteBtn').onclick = executeDeleteItem;
        }

        function closeConfirmModal() {
            document.getElementById('confirmBackdrop').classList.remove('active');
            document.getElementById('confirmModal').classList.remove('active');
            pendingDeleteId = null;
        }

        function executeDeleteItem() {
            if (!pendingDeleteId) return;

            delete items[pendingDeleteId];
            closeConfirmModal();
            renderList();
            updateTotals();
            saveData();
            showToast('Item eliminado', 'success');
        }

        function resetAll() {
            if (!confirm('¬øReiniciar todo? Se borrar√°n todos los items de esta lista.')) return;

            // Remover items de la lista actual
            for (const [id, item] of Object.entries(items)) {
                if (item.listType === currentList) {
                    delete items[id];
                }
            }

            renderList();
            updateTotals();
            saveData();
            showToast('Lista vaciada', 'success');
        }

        function shareWhatsApp() {
            const listItems = Object.values(items).filter(i => i.listType === currentList);
            const bought = listItems.filter(i => i.bought);
            const pending = listItems.filter(i => !i.bought);
            const total = bought.reduce((sum, i) => sum + (i.price || 0), 0);

            let text = `üõí *Compras - ${new Date().toLocaleDateString('es-AR')}*\n\n`;
            
            if (bought.length > 0) {
                text += `‚úÖ *Comprado (${bought.length}):*\n`;
                bought.forEach(i => {
                    text += `‚Ä¢ ${i.name}`;
                    if (i.price) text += ` - $${i.price.toLocaleString('es-AR')}`;
                    text += '\n';
                });
                text += `\nüí∞ *TOTAL: $${total.toLocaleString('es-AR')}*\n`;
            }

            if (pending.length > 0) {
                text += `\n‚è≥ *Pendiente (${pending.length}):*\n`;
                pending.slice(0, 10).forEach(i => {
                    text += `‚Ä¢ ${i.name}\n`;
                });
                if (pending.length > 10) {
                    text += `... y ${pending.length - 10} m√°s\n`;
                }
            }

            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        }

        // ==================== VOICE ====================
        let recognition = null;
        let isRecording = false;

        function toggleVoice() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                showToast('Voz no soportada', 'error');
                return;
            }

            const btn = document.getElementById('voiceBtn');

            if (isRecording) {
                recognition.stop();
                btn.classList.remove('recording');
                btn.textContent = 'üé§';
                isRecording = false;
            } else {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SR();
                recognition.lang = 'es-AR';
                recognition.continuous = false;

                recognition.onresult = function(e) {
                    document.getElementById('registerInput').value = e.results[0][0].transcript;
                    showPreview({ target: document.getElementById('registerInput') });
                    btn.classList.remove('recording');
                    btn.textContent = 'üé§';
                    isRecording = false;
                };

                recognition.onerror = function() {
                    btn.classList.remove('recording');
                    btn.textContent = 'üé§';
                    isRecording = false;
                };

                recognition.start();
                btn.classList.add('recording');
                btn.textContent = '‚èπ';
                isRecording = true;
                showToast('üé§ Habl√°...', 'success');
            }
        }

        // ==================== STORAGE ====================
        function saveData() {
            // Guardar estado actual de la semana
            if (currentWeekId) {
                weeks[currentWeekId] = {
                    ...weeks[currentWeekId],
                    items: items,
                    itemIdCounter: itemIdCounter,
                    currentList: currentList,
                    updatedAt: Date.now()
                };
            }

            // Guardar en localStorage
            saveToLocalStorage();

            // Guardar en la nube
            if (currentWeekId) {
                saveWeekToCloud(currentWeekId);
            }
        }

        function saveToLocalStorage() {
            const data = {
                weeks: weeks,
                currentWeekId: currentWeekId
            };
            localStorage.setItem('paulina_v5_weeks', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            // Intentar cargar nuevo formato
            const saved = localStorage.getItem('paulina_v5_weeks');
            if (saved) {
                const data = JSON.parse(saved);
                weeks = data.weeks || {};
                currentWeekId = data.currentWeekId || null;
                return;
            }

            // Migrar datos del formato anterior
            const oldSaved = localStorage.getItem('paulina_v4');
            if (oldSaved) {
                const oldData = JSON.parse(oldSaved);
                // Crear una semana con los datos anteriores
                const weekId = 'week_' + Date.now();
                weeks[weekId] = {
                    id: weekId,
                    name: 'Semana Migrada',
                    createdAt: Date.now(),
                    items: oldData.items || {},
                    itemIdCounter: oldData.itemIdCounter || 0,
                    currentList: oldData.currentList || 'general'
                };
                currentWeekId = weekId;
                saveToLocalStorage();
                // Opcional: eliminar datos viejos
                // localStorage.removeItem('paulina_v4');
            }
        }

        let unsubscribeListener = null;
        let lastSaveTime = 0;
        let localSaveId = null; // ID √∫nico para identificar guardados propios

        async function syncFromFirestore() {
            if (!firebaseReady || !db) return;

            const snapshot = await db.collection('weeks').get();

            snapshot.forEach(doc => {
                const weekData = doc.data();
                const localWeek = weeks[doc.id];

                // Si no existe localmente, usar el de la nube
                if (!localWeek) {
                    weeks[doc.id] = {
                        id: doc.id,
                        ...weekData
                    };
                } else {
                    // Merge inteligente a nivel de item
                    weeks[doc.id] = mergeWeekData(localWeek, weekData, doc.id);
                }
            });

            // Iniciar listener en tiempo real
            startRealtimeSync();
        }

        // Merge inteligente: compara items individuales por timestamp
        function mergeWeekData(localWeek, cloudWeek, weekId) {
            const merged = {
                id: weekId,
                name: cloudWeek.name || localWeek.name,
                createdAt: cloudWeek.createdAt || localWeek.createdAt,
                updatedAt: Math.max(cloudWeek.updatedAt || 0, localWeek.updatedAt || 0),
                currentList: cloudWeek.currentList || localWeek.currentList || 'general',
                itemIdCounter: Math.max(cloudWeek.itemIdCounter || 0, localWeek.itemIdCounter || 0),
                source: cloudWeek.source || localWeek.source,
                sourceData: cloudWeek.sourceData || localWeek.sourceData,
                items: {}
            };

            const localItems = localWeek.items || {};
            const cloudItems = cloudWeek.items || {};
            const allItemIds = new Set([...Object.keys(localItems), ...Object.keys(cloudItems)]);

            for (const itemId of allItemIds) {
                const localItem = localItems[itemId];
                const cloudItem = cloudItems[itemId];

                if (!localItem) {
                    // Item solo existe en la nube
                    merged.items[itemId] = cloudItem;
                } else if (!cloudItem) {
                    // Item solo existe local - mantener si tiene timestamp reciente o fue eliminado en nube
                    // Solo mantener si es reciente (√∫ltimos 30 segundos)
                    if (localItem.itemUpdatedAt && Date.now() - localItem.itemUpdatedAt < 30000) {
                        merged.items[itemId] = localItem;
                    }
                    // Si no, fue eliminado en la nube, no lo agregamos
                } else {
                    // Existe en ambos - usar el m√°s reciente
                    const localTs = localItem.itemUpdatedAt || 0;
                    const cloudTs = cloudItem.itemUpdatedAt || 0;
                    merged.items[itemId] = localTs > cloudTs ? localItem : cloudItem;
                }
            }

            return merged;
        }

        function startRealtimeSync() {
            if (!firebaseReady || !db || unsubscribeListener) return;

            unsubscribeListener = db.collection('weeks').onSnapshot(snapshot => {
                // Ignorar cambios propios (dentro de 1 segundo de guardar)
                if (Date.now() - lastSaveTime < 1000) return;

                let hasChanges = false;
                let updatedCurrentWeek = false;

                snapshot.docChanges().forEach(change => {
                    // Verificar si es nuestro propio guardado
                    const weekData = change.doc.data();
                    if (weekData.lastSaveId === localSaveId && Date.now() - lastSaveTime < 3000) {
                        return; // Ignorar nuestro propio guardado
                    }

                    if (change.type === 'modified' || change.type === 'added') {
                        const localWeek = weeks[change.doc.id];

                        if (!localWeek) {
                            weeks[change.doc.id] = {
                                id: change.doc.id,
                                ...weekData
                            };
                            hasChanges = true;
                        } else {
                            // Merge inteligente
                            const merged = mergeWeekData(localWeek, weekData, change.doc.id);

                            // Verificar si hay cambios reales
                            const itemsChanged = JSON.stringify(merged.items) !== JSON.stringify(localWeek.items);
                            if (itemsChanged) {
                                weeks[change.doc.id] = merged;
                                hasChanges = true;
                                if (change.doc.id === currentWeekId) {
                                    updatedCurrentWeek = true;
                                }
                            }
                        }
                    } else if (change.type === 'removed') {
                        if (weeks[change.doc.id]) {
                            delete weeks[change.doc.id];
                            hasChanges = true;
                        }
                    }
                });

                if (hasChanges) {
                    saveToLocalStorage();
                    renderWeeksDropdown();

                    // Si la semana actual fue modificada, recargar
                    if (updatedCurrentWeek && currentWeekId && weeks[currentWeekId]) {
                        items = weeks[currentWeekId].items || {};
                        itemIdCounter = weeks[currentWeekId].itemIdCounter || 0;
                        renderList();
                        updateTotals();
                        showToast('Lista sincronizada', 'info');
                    }

                    updateSyncStatus('synced', 'Sincronizado');
                }
            }, error => {
                console.error('Error en listener:', error);
                updateSyncStatus('error', 'Error de conexi√≥n');
            });
        }

        async function saveWeekToCloud(weekId) {
            if (!firebaseReady || !db || !weekId) return;

            const week = weeks[weekId];
            if (!week) return;

            updateSyncStatus('syncing', 'Guardando...');
            lastSaveTime = Date.now();
            localSaveId = 'save_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            try {
                await db.collection('weeks').doc(weekId).set({
                    name: week.name,
                    createdAt: week.createdAt,
                    updatedAt: Date.now(),
                    items: week.items || {},
                    itemIdCounter: week.itemIdCounter || 0,
                    currentList: week.currentList || 'general',
                    source: week.source || null,
                    sourceData: week.sourceData || null,
                    lastSaveId: localSaveId
                });
                updateSyncStatus('synced', 'Guardado');
            } catch (error) {
                console.error('Error saving to Firestore:', error);
                updateSyncStatus('error', 'Error al guardar');
            }
        }

        async function deleteWeekFromCloud(weekId) {
            if (!firebaseReady || !db || !weekId) return;

            try {
                await db.collection('weeks').doc(weekId).delete();
            } catch (error) {
                console.error('Error deleting from Firestore:', error);
            }
        }

        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('syncText');

            statusEl.className = 'sync-status ' + status;
            textEl.textContent = text;
        }

        async function forceSync() {
            if (!firebaseReady || !db) {
                showToast('Sin conexi√≥n a la nube', 'warning');
                return;
            }

            updateSyncStatus('syncing', 'Sincronizando...');
            const syncBtn = document.getElementById('syncBtn');
            if (syncBtn) {
                syncBtn.style.animation = 'spin 1s linear infinite';
            }

            try {
                // Primero guardar cambios locales
                if (currentWeekId) {
                    await saveWeekToCloud(currentWeekId);
                }

                // Luego obtener cambios de la nube
                await syncFromFirestore();

                // Recargar datos de la semana actual
                if (currentWeekId && weeks[currentWeekId]) {
                    items = weeks[currentWeekId].items || {};
                    itemIdCounter = weeks[currentWeekId].itemIdCounter || 0;
                    renderList();
                    updateTotals();
                }

                renderWeeksDropdown();
                updateSyncStatus('synced', 'Sincronizado');
                showToast('Lista sincronizada', 'success');
            } catch (error) {
                console.error('Error en sincronizaci√≥n:', error);
                updateSyncStatus('error', 'Error');
                showToast('Error al sincronizar', 'error');
            } finally {
                if (syncBtn) {
                    syncBtn.style.animation = '';
                }
            }
        }

        // ==================== WEEKS MANAGEMENT ====================
        function createWeekData(name) {
            const weekId = 'week_' + Date.now();
            weeks[weekId] = {
                id: weekId,
                name: name,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                items: {},
                itemIdCounter: 0,
                currentList: 'general'
            };
            return weekId;
        }

        function renderWeeksDropdown() {
            const dropdown = document.getElementById('weekDropdown');
            const weekIds = Object.keys(weeks).sort((a, b) =>
                (weeks[b].createdAt || 0) - (weeks[a].createdAt || 0)
            );

            if (weekIds.length === 0) {
                dropdown.innerHTML = '<option value="">No hay semanas</option>';
                return;
            }

            dropdown.innerHTML = weekIds.map(id => {
                const week = weeks[id];
                let displayName = week.name;

                // Agregar fechas si est√°n disponibles
                if (week.sourceData && week.sourceData.fechas) {
                    displayName += ` (${week.sourceData.fechas})`;
                } else if (week.createdAt) {
                    const date = new Date(week.createdAt);
                    const dateStr = date.toLocaleDateString('es-AR', { day: 'numeric', month: 'short' });
                    displayName += ` - ${dateStr}`;
                }

                return `<option value="${id}" ${id === currentWeekId ? 'selected' : ''}>${displayName}</option>`;
            }).join('');
        }

        function selectWeek(weekId) {
            if (!weekId || !weeks[weekId]) return;

            currentWeekId = weekId;
            const week = weeks[weekId];

            // Cargar datos de la semana
            items = week.items || {};
            itemIdCounter = week.itemIdCounter || 0;
            currentList = week.currentList || 'general';

            // Actualizar UI
            document.getElementById('headerTitle').textContent = 'üõí ' + week.name;

            // Mostrar fechas del men√∫ si es de Paulina, sino la fecha de creaci√≥n
            if (week.sourceData && week.sourceData.fechas) {
                document.getElementById('headerSubtitle').textContent = week.sourceData.fechas;
            } else {
                document.getElementById('headerSubtitle').textContent = formatWeekDate(week.createdAt);
            }

            // Actualizar dropdown
            document.getElementById('weekDropdown').value = weekId;

            // Actualizar tabs
            document.querySelectorAll('.list-tab').forEach(t => t.classList.remove('active'));
            const tabIndex = currentList === 'general' ? 0 : 1;
            document.querySelectorAll('.list-tab')[tabIndex]?.classList.add('active');

            // Renderizar
            renderList();
            updateTotals();

            // Guardar selecci√≥n actual
            saveToLocalStorage();
        }

        function formatWeekDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return 'Creada el ' + date.toLocaleDateString('es-AR', {
                day: 'numeric',
                month: 'long'
            });
        }

        async function deleteCurrentWeek() {
            if (!currentWeekId) return;

            const weekCount = Object.keys(weeks).length;
            if (weekCount <= 1) {
                showToast('No pod√©s eliminar la √∫nica semana', 'warning');
                return;
            }

            const weekName = weeks[currentWeekId]?.name || 'esta semana';
            if (!confirm(`¬øEliminar "${weekName}"? Se perder√°n todos los datos.`)) return;

            const weekIdToDelete = currentWeekId;

            // Eliminar de la nube
            await deleteWeekFromCloud(weekIdToDelete);

            // Eliminar localmente
            delete weeks[weekIdToDelete];

            // Seleccionar otra semana
            const remainingWeeks = Object.keys(weeks);
            currentWeekId = remainingWeeks[0];

            saveToLocalStorage();
            renderWeeksDropdown();
            selectWeek(currentWeekId);

            showToast('Semana eliminada', 'success');
        }

        // ==================== TOAST ====================
        function showToast(msg, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // ==================== IMPORT FROM PAULINA ====================
        let pendingPaulinaData = null;  // Datos del men√∫ cargado pendiente de importar

        // ============ Modal de importaci√≥n ============

        let selectedImportMode = null; // 'general', 'veggie', or 'platos'

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('importJsonInput').value = '';
            document.getElementById('importStep1').style.display = 'block';
            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('importStep3').style.display = 'none';
            pendingPaulinaData = null;
            selectedImportMode = null;
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            pendingPaulinaData = null;
            selectedImportMode = null;
        }

        // Crear lista vac√≠a desde el modal unificado
        async function createEmptyList() {
            const now = new Date();
            const weekNum = Math.ceil((now - new Date(now.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
            const name = `Semana ${weekNum}`;

            const weekId = 'week_' + Date.now();
            weeks[weekId] = {
                id: weekId,
                name: name,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                items: {},
                itemIdCounter: 0,
                currentList: 'general'
            };

            await saveWeekToCloud(weekId);

            closeImportModal();
            renderWeeksDropdown();
            selectWeek(weekId);

            showToast('Lista vac√≠a creada', 'success');
        }

        function showStep(step) {
            document.getElementById('importStep1').style.display = step === 1 ? 'block' : 'none';
            document.getElementById('importStep2').style.display = step === 2 ? 'block' : 'none';
            document.getElementById('importStep3').style.display = step === 3 ? 'block' : 'none';
        }

        function backToStep1() { showStep(1); }
        function backToStep2() { showStep(2); }

        // ---- Paso 2: Buscar y mostrar semanas disponibles ----

        async function browseAvailableWeeks() {
            showStep(2);
            document.getElementById('availableWeeksLoading').style.display = 'block';
            document.getElementById('availableWeeksList').innerHTML = '';
            document.getElementById('availableWeeksEmpty').style.display = 'none';

            if (!firebaseReady || !db) {
                document.getElementById('availableWeeksLoading').style.display = 'none';
                document.getElementById('availableWeeksEmpty').style.display = 'block';
                return;
            }

            try {
                const snapshot = await db.collection('paulina_menus').get();
                document.getElementById('availableWeeksLoading').style.display = 'none';

                if (snapshot.empty) {
                    document.getElementById('availableWeeksEmpty').style.display = 'block';
                    return;
                }

                // Ordenar: especiales primero, luego por semana descendente
                const docs = [];
                snapshot.forEach(doc => docs.push(doc.data()));
                docs.sort((a, b) => {
                    const aIsSpecial = !a.semana;
                    const bIsSpecial = !b.semana;
                    if (aIsSpecial !== bIsSpecial) return aIsSpecial ? -1 : 1;
                    return (b.semana || 0) - (a.semana || 0);
                });

                const listEl = document.getElementById('availableWeeksList');
                listEl.innerHTML = '';

                docs.forEach(data => {
                    const generalCount = data.general
                        ? Object.values(data.general).reduce((s, items) => s + items.length, 0)
                        : 0;
                    const veggieCount = data.veggie
                        ? Object.values(data.veggie).reduce((s, items) => s + items.length, 0)
                        : 0;
                    const platosCount = data.platos ? data.platos.length : 0;
                    const recetasCount = data.recetas ? Object.keys(data.recetas).length : 0;
                    const hasSeparateVeggie = veggieCount > 0 && JSON.stringify(data.veggie) !== JSON.stringify(data.general);
                    const isSpecial = !data.semana;

                    let badges = '';
                    if (isSpecial) badges += `<span class="badge badge-platos">Especial</span> `;
                    if (generalCount > 0) badges += `<span class="badge badge-primary">${generalCount} items</span> `;
                    if (hasSeparateVeggie) badges += `<span class="badge badge-veggie">Veggie</span> `;
                    if (recetasCount > 0) badges += `<span class="badge badge-dias">${recetasCount} d√≠as</span> `;
                    if (platosCount > 0 && recetasCount === 0) badges += `<span class="badge badge-platos">${platosCount} platos</span>`;

                    const card = document.createElement('div');
                    card.className = 'week-card';
                    card.onclick = () => selectWeekToImport(data);
                    card.innerHTML = `
                        <div class="week-card-title">${data.titulo || 'Semana ' + data.semana}</div>
                        ${data.fechas ? `<div class="week-card-dates">${data.fechas}</div>` : ''}
                        <div class="week-card-badges">${badges}</div>
                    `;
                    listEl.appendChild(card);
                });
            } catch (error) {
                console.error('Error buscando semanas:', error);
                document.getElementById('availableWeeksLoading').style.display = 'none';
                showToast('Error al buscar semanas', 'error');
            }
        }

        // ---- Paso 3: Configuraci√≥n modular de importaci√≥n ----

        function selectWeekToImport(data) {
            pendingPaulinaData = data;
            showStep(3);

            document.getElementById('menuTitle').textContent = data.titulo || 'Men√∫';
            document.getElementById('menuDates').textContent = data.fechas || '';

            const tieneRecetas = data.recetas && Object.keys(data.recetas).length > 0;
            const tienePlatos = data.platos && data.platos.length > 0;
            const tieneGeneral = data.general && Object.keys(data.general).length > 0;
            const tieneVeggie = data.veggie && Object.keys(data.veggie).length > 0;
            const hasSeparateVeggie = tieneVeggie && JSON.stringify(data.veggie) !== JSON.stringify(data.general);

            // 1. Tipo de lista: General / Vegetariano
            selectedImportMode = 'general';
            const toggleGeneral = document.getElementById('toggleGeneral');
            const toggleVeggie = document.getElementById('toggleVeggie');
            toggleGeneral.classList.add('active');
            toggleGeneral.classList.remove('veggie-active');
            toggleVeggie.classList.remove('active', 'veggie-active');
            toggleVeggie.style.display = hasSeparateVeggie ? '' : 'none';

            // 2. D√≠as (si hay recetas por d√≠a)
            const diasSection = document.getElementById('diasSection');
            if (tieneRecetas) {
                renderDiasCheckboxes(data.recetas);
                diasSection.style.display = 'block';
            } else {
                diasSection.style.display = 'none';
            }

            // 2b. Platos individuales (para men√∫s especiales sin recetas por d√≠a)
            const platosSection = document.getElementById('platosSection');
            if (tienePlatos && !tieneRecetas) {
                renderPlatosCheckboxes(data);
                platosSection.style.display = 'block';
            } else {
                platosSection.style.display = 'none';
            }

            // 3. Categor√≠as extras: Yapa / Comod√≠n
            renderExtrasCheckboxes(data);
        }

        function selectListType(type) {
            selectedImportMode = type;

            const toggleGeneral = document.getElementById('toggleGeneral');
            const toggleVeggie = document.getElementById('toggleVeggie');

            toggleGeneral.classList.toggle('active', type === 'general');
            toggleGeneral.classList.remove('veggie-active');
            toggleVeggie.classList.toggle('veggie-active', type === 'veggie');
            toggleVeggie.classList.remove('active');

            // Actualizar extras con la lista seleccionada
            if (pendingPaulinaData) {
                renderExtrasCheckboxes(pendingPaulinaData);
            }
        }

        // ---- Categor√≠as extras (Yapa, Comod√≠n) ----

        const EXTRA_CATEGORIES = ['yapa', 'comod√≠n', 'comodin'];

        function renderExtrasCheckboxes(data) {
            const container = document.getElementById('extrasContainer');
            const section = document.getElementById('extrasSection');
            container.innerHTML = '';

            const listData = selectedImportMode === 'veggie' ? data.veggie : data.general;
            if (!listData) {
                section.style.display = 'none';
                return;
            }

            // Encontrar categor√≠as extras disponibles
            const extras = [];
            for (const [catName, items] of Object.entries(listData)) {
                const lower = catName.toLowerCase();
                if (EXTRA_CATEGORIES.some(ec => lower.includes(ec))) {
                    extras.push({ name: catName, count: items.length });
                }
            }

            if (extras.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            extras.forEach((extra, idx) => {
                const mappedName = mapCategoryName(extra.name);
                const div = document.createElement('div');
                div.className = 'import-extra-toggle active';
                div.onclick = function(e) {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = this.querySelector('input[type="checkbox"]');
                        cb.checked = !cb.checked;
                        this.classList.toggle('active', cb.checked);
                    }
                };
                div.innerHTML = `
                    <input type="checkbox" id="extra_${idx}" data-category="${extra.name}" checked
                           onchange="this.closest('.import-extra-toggle').classList.toggle('active', this.checked)">
                    <div class="import-extra-info">
                        <div class="import-extra-name">${mappedName}</div>
                        <div class="import-extra-desc">${extra.count} productos extras</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ---- Selecci√≥n de d√≠as ----

        function renderDiasCheckboxes(recetas) {
            const container = document.getElementById('diasContainer');
            container.innerHTML = '';

            const diasOrden = ['Lunes', 'Martes', 'Mi√©rcoles', 'Miercoles', 'Jueves', 'Viernes', 'S√°bado', 'Sabado', 'Domingo'];

            // Ordenar los d√≠as seg√∫n el orden natural de la semana
            const diasKeys = Object.keys(recetas).sort((a, b) => {
                const ia = diasOrden.findIndex(d => d.toLowerCase() === a.toLowerCase());
                const ib = diasOrden.findIndex(d => d.toLowerCase() === b.toLowerCase());
                return (ia === -1 ? 99 : ia) - (ib === -1 ? 99 : ib);
            });

            diasKeys.forEach(dia => {
                const receta = recetas[dia];
                const ingredientCount = receta.ingredientes ? receta.ingredientes.length : 0;
                const diaDiv = document.createElement('div');
                diaDiv.className = 'check-row';
                diaDiv.onclick = function(e) {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = this.querySelector('input[type="checkbox"]');
                        cb.checked = !cb.checked;
                    }
                };
                diaDiv.innerHTML = `
                    <input type="checkbox" id="dia_${dia}" data-dia="${dia}" checked>
                    <label for="dia_${dia}">
                        <div class="check-row-title">${dia}</div>
                        <div class="check-row-subtitle">${receta.nombre || 'Men√∫ del d√≠a'} (${ingredientCount} ing.)</div>
                    </label>
                `;
                container.appendChild(diaDiv);
            });
        }

        function selectAllDias() {
            document.querySelectorAll('#diasContainer input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function selectNoneDias() {
            document.querySelectorAll('#diasContainer input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        // ---- Platos (para men√∫s especiales sin recetas por d√≠a) ----

        function renderPlatosCheckboxes(data) {
            const container = document.getElementById('platosContainer');
            container.innerHTML = '';

            data.platos.forEach((plato, index) => {
                const ingredientCount = plato.ingredientes ? plato.ingredientes.length : 0;
                const platoDiv = document.createElement('div');
                platoDiv.className = 'check-row';
                platoDiv.onclick = function(e) {
                    if (e.target.tagName !== 'INPUT') {
                        const cb = this.querySelector('input[type="checkbox"]');
                        cb.checked = !cb.checked;
                    }
                };
                platoDiv.innerHTML = `
                    <input type="checkbox" id="plato_${index}" checked>
                    <label for="plato_${index}">
                        <div class="check-row-title">${index + 1}. ${plato.nombre || 'Plato ' + (index + 1)}</div>
                        <div class="check-row-subtitle">${ingredientCount} ingredientes</div>
                    </label>
                `;
                container.appendChild(platoDiv);
            });
        }

        function selectAllPlatos() {
            document.querySelectorAll('#platosContainer input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function selectNonePlatos() {
            document.querySelectorAll('#platosContainer input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        // ---- Importar desde JSON pegado ----

        function loadFromJson() {
            const jsonInput = document.getElementById('importJsonInput').value.trim();
            if (!jsonInput) {
                showToast('Peg√° el JSON del scraper', 'warning');
                return;
            }
            try {
                const data = JSON.parse(jsonInput);
                pendingPaulinaData = data;
                selectWeekToImport(data);
            } catch (e) {
                showToast('JSON inv√°lido', 'error');
            }
        }

        // ---- Obtener d√≠as seleccionados ----

        function getSelectedDias() {
            const selected = [];
            document.querySelectorAll('#diasContainer input[type="checkbox"]:checked').forEach(cb => {
                selected.push(cb.dataset.dia);
            });
            return selected;
        }

        // ---- Ejecutar la importaci√≥n seg√∫n la configuraci√≥n modular ----

        async function executeImport() {
            if (!pendingPaulinaData) {
                showToast('No hay datos cargados', 'error');
                return;
            }

            const data = pendingPaulinaData;
            const tieneRecetas = data.recetas && Object.keys(data.recetas).length > 0;
            const tienePlatos = data.platos && data.platos.length > 0;
            const listType = selectedImportMode; // 'general' or 'veggie'
            const sourceList = listType === 'veggie' ? data.veggie : data.general;

            if (!sourceList || Object.keys(sourceList).length === 0) {
                showToast('No hay datos para esta lista', 'error');
                return;
            }

            // Obtener categor√≠as extras seleccionadas
            const selectedExtras = new Set();
            document.querySelectorAll('#extrasContainer input[type="checkbox"]:checked').forEach(cb => {
                selectedExtras.add(cb.dataset.category);
            });

            // Obtener categor√≠as extras NO seleccionadas (para excluirlas)
            const excludedExtras = new Set();
            document.querySelectorAll('#extrasContainer input[type="checkbox"]:not(:checked)').forEach(cb => {
                excludedExtras.add(cb.dataset.category);
            });

            let itemsToImport = {};

            if (tieneRecetas) {
                // Men√∫ semanal con recetas por d√≠a
                const selectedDias = getSelectedDias();
                if (selectedDias.length === 0) {
                    showToast('Seleccion√° al menos un d√≠a', 'warning');
                    return;
                }

                const allDias = [...document.querySelectorAll('#diasContainer input[type="checkbox"]')].map(cb => cb.dataset.dia);

                if (selectedDias.length === allDias.length) {
                    // Todos los d√≠as: usar lista pre-armada, filtrando extras excluidos
                    for (const [cat, items] of Object.entries(sourceList)) {
                        if (!excludedExtras.has(cat)) {
                            itemsToImport[cat] = items;
                        }
                    }
                } else {
                    // D√≠as espec√≠ficos: combinar ingredientes de esos d√≠as
                    const combinedIngredients = [];
                    selectedDias.forEach(dia => {
                        const receta = data.recetas[dia];
                        if (receta && receta.ingredientes) {
                            combinedIngredients.push(...receta.ingredientes);
                        }
                    });
                    itemsToImport['Supermercado üè™'] = combinedIngredients;

                    // Agregar categor√≠as extras seleccionadas de la lista original
                    for (const extraCat of selectedExtras) {
                        if (sourceList[extraCat]) {
                            itemsToImport[extraCat] = sourceList[extraCat];
                        }
                    }
                }
            } else if (tienePlatos) {
                // Men√∫ especial con platos individuales
                const selectedIndices = [];
                document.querySelectorAll('#platosContainer input[type="checkbox"]:checked').forEach(cb => {
                    const index = parseInt(cb.id.replace('plato_', ''));
                    if (!isNaN(index)) selectedIndices.push(index);
                });

                if (selectedIndices.length === 0) {
                    showToast('Seleccion√° al menos un plato', 'warning');
                    return;
                }

                const combinedIngredients = [];
                selectedIndices.forEach(index => {
                    const plato = data.platos[index];
                    if (plato && plato.ingredientes) {
                        combinedIngredients.push(...plato.ingredientes);
                    }
                });
                itemsToImport['Supermercado üè™'] = combinedIngredients;

                // Agregar categor√≠as extras
                for (const extraCat of selectedExtras) {
                    if (sourceList[extraCat]) {
                        itemsToImport[extraCat] = sourceList[extraCat];
                    }
                }
            } else {
                // Sin recetas ni platos: importar lista completa filtrando extras excluidos
                for (const [cat, items] of Object.entries(sourceList)) {
                    if (!excludedExtras.has(cat)) {
                        itemsToImport[cat] = items;
                    }
                }
            }

            // Construir itemsToImport wrapper para createWeekFromImport
            const importWrapper = {};
            importWrapper[listType] = itemsToImport;

            await createWeekFromImport(data, importWrapper);
        }

        // ---- Crear semana desde datos importados ----

        async function createWeekFromImport(data, itemsToImport) {
            const weekName = data.titulo || `Semana ${data.semana || 'Importada'}`;
            const weekId = 'week_' + Date.now();

            let counter = 0;
            let duplicatesSkipped = 0;
            let totalProcessed = 0;
            const newItems = {};
            // Deduplicar por categor√≠a dentro de cada listType,
            // no entre categor√≠as distintas (ej: Comod√≠n vs Supermercado son cosas diferentes)
            const seenItems = {};

            function addItemIfNotDuplicate(product, categoryName, listType) {
                totalProcessed++;
                const normalized = normalizeIngredient(product);
                const dedupKey = `${listType}::${categoryName}`;
                if (!seenItems[dedupKey]) seenItems[dedupKey] = new Set();

                console.log(`[Dedup] "${product}" ‚Üí "${normalized}" (${dedupKey})`);
                if (!normalized || seenItems[dedupKey].has(normalized)) {
                    duplicatesSkipped++;
                    console.log(`  ‚Üí DUPLICADO (ya existe en ${dedupKey})`);
                    return false;
                }
                seenItems[dedupKey].add(normalized);
                newItems[counter++] = {
                    name: product,
                    category: categoryName,
                    bought: false,
                    price: 0,
                    isExtra: false,
                    listType: listType,
                    itemUpdatedAt: Date.now()
                };
                return true;
            }

            // Procesar lista general
            if (itemsToImport.general) {
                for (const [category, products] of Object.entries(itemsToImport.general)) {
                    const categoryName = mapCategoryName(category);
                    for (const product of products) {
                        addItemIfNotDuplicate(product, categoryName, 'general');
                    }
                }
            }

            // Procesar lista veggie
            if (itemsToImport.veggie) {
                for (const [category, products] of Object.entries(itemsToImport.veggie)) {
                    const categoryName = mapCategoryName(category);
                    for (const product of products) {
                        addItemIfNotDuplicate(product, categoryName, 'veggie');
                    }
                }
            }

            weeks[weekId] = {
                id: weekId,
                name: weekName,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                items: newItems,
                itemIdCounter: counter,
                currentList: selectedImportMode === 'veggie' ? 'veggie' : 'general',
                source: 'paulina',
                sourceData: {
                    semana: data.semana || '',
                    fechas: data.fechas || ''
                }
            };

            await saveWeekToCloud(weekId);
            closeImportModal();
            renderWeeksDropdown();
            selectWeek(weekId);

            const totalItems = Object.keys(newItems).length;
            let msg = `${totalItems} productos importados`;
            if (duplicatesSkipped > 0) {
                msg += ` (${duplicatesSkipped} duplicados eliminados)`;
            }
            console.log(`[Import] Total procesados: ${totalProcessed}, Importados: ${totalItems}, Duplicados: ${duplicatesSkipped}`);
            showToast(msg, 'success');
        }

        function mapCategoryName(category) {
            // Mapear nombres de categor√≠a del scraper a los de la app
            const lower = category.toLowerCase();

            if (lower.includes('supermercado')) return 'Supermercado üè™';
            if (lower.includes('carne')) return 'Carnes ü•©';
            if (lower.includes('diet√©tica') || lower.includes('dietetica')) return 'Diet√©tica ü•ó';
            if (lower.includes('verduler√≠a') || lower.includes('verduleria')) return 'Verduler√≠a ü•¨';
            if (lower.includes('yapa')) return 'Yapa ‚≠ê';
            if (lower.includes('comod√≠n') || lower.includes('comodin')) return 'Comod√≠n üëë';
            if (lower.includes('casa') || lower.includes('seguro')) return 'Ya ten√©s ‚úÖ';

            // Si ya tiene emoji, devolverlo como est√°
            if (/[\u{1F300}-\u{1F9FF}]/u.test(category)) return category;

            return category;
        }

    </script>
</body>
</html>
