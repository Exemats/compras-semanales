name: Scraper Paulina Cocina Automatico

# Ejecucion automatica:
#   - Lunes 10:00 AM Argentina (UTC-3 = 13:00 UTC): captura menus nuevos publicados al inicio de semana
#   - Sabado  8:00 AM Argentina (UTC-3 = 11:00 UTC): sincronizacion semanal de respaldo
on:
  schedule:
    - cron: '0 13 * * 1'  # Lunes    10:00 AM Argentina
    - cron: '0 11 * * 6'  # Sabados   8:00 AM Argentina

  # Permite ejecutar manualmente desde GitHub Actions > Run workflow
  workflow_dispatch:
    inputs:
      modo:
        description: 'Modo de ejecucion'
        required: true
        default: 'reciente'
        type: choice
        options:
          - reciente        # Semana mas reciente + especiales
          - semana_especifica
          - todas           # Todas las semanas + especiales
          - rango
          - especiales      # Solo menus especiales
          - listar          # Solo muestra menus disponibles (no descarga, util para diagnostico)
          - reset           # Backup + borrar DB + re-descargar todo
      semana:
        description: 'Numero de semana (solo si modo = semana_especifica)'
        required: false
        type: string
      rango:
        description: 'Rango de semanas ej: 3-5 (solo si modo = rango)'
        required: false
        type: string

jobs:
  scraper:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: |
          pip install --upgrade requests beautifulsoup4 firebase-admin

      # ----------------------------------------------------------------
      # Verificar que los secrets criticos estan configurados.
      # Si faltan, falla inmediatamente con un mensaje claro en lugar de
      # continuar y producir errores crÃ­pticos mas adelante.
      # ----------------------------------------------------------------
      - name: Verificar secrets configurados
        env:
          PAULINA_USER: ${{ secrets.PAULINA_USER }}
          PAULINA_PASS: ${{ secrets.PAULINA_PASS }}
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
        run: |
          MODO="${{ github.event.inputs.modo }}"
          if [ -z "$MODO" ]; then MODO="automatico"; fi

          echo "ğŸ” Verificando configuracion para modo: $MODO"

          MISSING=0

          if [ -z "$PAULINA_USER" ]; then
            echo "âŒ SECRET FALTANTE: PAULINA_USER"
            echo "   â†’ Ir a Settings > Secrets and variables > Actions > New repository secret"
            MISSING=1
          else
            echo "âœ… PAULINA_USER configurado"
          fi

          if [ -z "$PAULINA_PASS" ]; then
            echo "âŒ SECRET FALTANTE: PAULINA_PASS"
            MISSING=1
          else
            echo "âœ… PAULINA_PASS configurado"
          fi

          if [ "$MODO" != "listar" ]; then
            if [ -z "$FIREBASE_CREDENTIALS" ]; then
              echo "âŒ SECRET FALTANTE: FIREBASE_CREDENTIALS"
              echo "   â†’ Pegar el contenido de firebase_credentials.json como secret"
              MISSING=1
            else
              # Verificar que es un JSON valido con el campo requerido
              if echo "$FIREBASE_CREDENTIALS" | python3 -c "import sys,json; d=json.load(sys.stdin); assert 'project_id' in d" 2>/dev/null; then
                PROJECT=$(echo "$FIREBASE_CREDENTIALS" | python3 -c "import sys,json; print(json.load(sys.stdin)['project_id'])")
                echo "âœ… FIREBASE_CREDENTIALS valido (proyecto: $PROJECT)"
              else
                echo "âŒ FIREBASE_CREDENTIALS no es un JSON valido o le falta el campo project_id"
                MISSING=1
              fi
            fi
          fi

          if [ "$MISSING" -eq 1 ]; then
            echo ""
            echo "ğŸ’¡ Ver SETUP_FIREBASE.md para instrucciones de configuracion"
            exit 1
          fi

      # ----------------------------------------------------------------
      # Crear el archivo de credenciales de Firebase.
      # Se usa printf en lugar de echo para preservar exactamente los
      # caracteres del JSON (incluyendo la clave privada RSA).
      # ----------------------------------------------------------------
      - name: Crear archivo de credenciales Firebase
        if: ${{ github.event.inputs.modo != 'listar' }}
        env:
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
        run: |
          printf '%s' "$FIREBASE_CREDENTIALS" > firebase_credentials.json
          echo "ğŸ“„ Credenciales escritas ($(wc -c < firebase_credentials.json) bytes)"

      # ----------------------------------------------------------------
      # Ejecutar el scraper segun el modo seleccionado
      # ----------------------------------------------------------------
      - name: Ejecutar scraper
        env:
          PAULINA_USER: ${{ secrets.PAULINA_USER }}
          PAULINA_PASS: ${{ secrets.PAULINA_PASS }}
        run: |
          MODO="${{ github.event.inputs.modo }}"

          # Si es ejecucion programada (sin inputs manuales), usar 'reciente'
          if [ -z "$MODO" ]; then
            MODO="reciente"
          fi

          echo "ğŸš€ Modo: $MODO"
          echo "================================"

          case "$MODO" in

            "listar")
              echo "ğŸ“‹ Listando menus disponibles en el sitio (sin descargar)..."
              python paulina_scraper.py --menus
              ;;

            "reciente")
              echo "ğŸ“… Descargando semana mas reciente..."
              python paulina_scraper.py
              EXIT_SEMANAL=$?

              echo ""
              echo "ğŸŒŸ Descargando menus especiales..."
              python paulina_scraper.py --especiales
              EXIT_ESP=$?

              # Exito si al menos uno funciono
              if [ $EXIT_SEMANAL -ne 0 ] && [ $EXIT_ESP -ne 0 ]; then
                echo "âŒ No se pudo descargar ni la semana ni los especiales"
                exit 1
              fi
              ;;

            "semana_especifica")
              SEMANA="${{ github.event.inputs.semana }}"
              if [ -z "$SEMANA" ]; then
                echo "âŒ Error: especifica el numero de semana en el campo 'semana'"
                exit 1
              fi
              echo "ğŸ“… Descargando semana $SEMANA..."
              python paulina_scraper.py --semana "$SEMANA"
              ;;

            "todas")
              echo "ğŸ“…ğŸŒŸ Descargando todas las semanas disponibles + especiales..."
              python paulina_scraper.py --todas
              ;;

            "rango")
              RANGO="${{ github.event.inputs.rango }}"
              if [ -z "$RANGO" ]; then
                echo "âŒ Error: especifica el rango (ej: 3-5) en el campo 'rango'"
                exit 1
              fi
              echo "ğŸ“… Descargando semanas $RANGO..."
              python paulina_scraper.py --rango "$RANGO"
              ;;

            "especiales")
              echo "ğŸŒŸ Descargando menus especiales..."
              python paulina_scraper.py --especiales
              ;;

            "reset")
              echo "ğŸ”„ Reseteando base de datos (backup + borrar + re-descargar todo)..."
              python paulina_scraper.py --reset-db
              ;;

            *)
              echo "âŒ Modo desconocido: $MODO"
              exit 1
              ;;
          esac

      - name: Limpiar credenciales
        if: always()
        run: |
          rm -f firebase_credentials.json
          echo "ğŸ§¹ Credenciales eliminadas"
